/*!
   evolutility-ui-jquery 1.2.3 
   (c) 2020 Olivier Giulieri 
   http://evoluteur.github.io/evolutility-ui-jquery/  
*/

var Evol;function syntaxHighlight(e){return"string"!=typeof e&&(e=JSON.stringify(e,void 0,2)),(e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")).replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){var t="number";return/^"/.test(e)?t=/:$/.test(e)?"key":"string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),'<span class="'+t+'">'+e+"</span>"})}(Evol=Evol||{}).Config={localStorage:!0},(Evol=Evol||{}).i18n={LOCALE:"EN",getLabel:function(e,t,i){var l;if(-1<e.indexOf(".")){var n=e.split(".");l=this[n[0]][n[1]]}else l=this[e];return t&&l&&(l=l.replace("{0}",t),i&&(l=l.replace("{1}",i))),l},tools:{View:"View",bBrowse:"Browse",bEdit:"Edit",bMini:"Mini",bNew:"New",newEntity:"New {0}",bExport:"Export",bImport:"Import",bDelete:"Delete",bList:"List",bCards:"Cards",bJSON:"JSON",bFilter:"Filter",bBubbles:"Bubbles",bCharts:"Charts",bSave:"Save",bSaveAdd:"Save and Add Another",bOK:"OK",bCancel:"Cancel",vizGroupBy:"Group by",vizColorBy:"Color by",vizSizeBy:"Size by",prev:"Previous",next:"Next",finish:"Finish !"},saved:"{0} saved.",unSavedTitle:"Changes pending",unSavedChanges:'Do you want to save the changes you made to "{0}"?',warnNoSave:"Your changes will be lost if you don't save them.",bNoSave:"Don't Save",deleteX:"Delete {0}",delete1:'Do you really want to delete the {0} "{1}"?',deleteN:"Delete {0} {1}?",deleted1:"{0} deleted.",notFound:"Item not found.",notFoundMsg:"No {0} found.",notFoundMsgId:'No {0} found for ID="{1}".',yes:"Yes",no:"No",none:"None",na:"N/A",nodata:"No data available.",notEnoughdata:"Not enough data available.",nopix:"No picture.",nochart:"No charts available.",badchart:"Not enough information provided to draw charts.",range:"{0} - {1} of {2} {3}",selected:"{0} selected",msg:{sgn_money:"$",sgn_email:"@",added:'New {0} "{1}" added.',updated:'{0} "{1}" updated.',deleted:'{0} "{1}" deleted.'},validation:{incomplete:"Some information is missing or invalid.",invalid:"Invalid format.",invalidList:'{0} values in "{1}" are invalid.',invalidList1:'1 value in "{1}" is invalid.',empty:'"{0}" must have a value.',email:'"{0}" must be a valid email formatted like "name@domain.com".',integer:'"{0}" must only use numbers.',decimal:'"{0}" must be a valid decimal numbers.',money:'"{0}" must be a valid number.',date:'"{0}" must be a valid date, format must be "MM/DD/YYYY" like "12/24/2015".',datetime:'"{0}" must be a valid date/time, format must be "MM/DD/YYYY hh:mm AM/PM" like "12/24/2015 10:30 AM".',time:'"{0}" must be a valid date/time, format must be "hh:mm AM/PM" like "10:30 AM".',json:'"{0}" must be a valid JSON expression like "{"a": 1}".',max:'"{0}" must be smaller or equal to {1}.',min:'"{0}" must be greater or equal to {1}.',maxLength:'"{0}" must be {1} characters long maximum.',minLength:'"{0}" must be at least {1} characters long.',minMaxLength:'"{0}" must be between {1} and {2} characters long.',regExp:'"{0}" is not of the expected format.'},charts:{aByB:"{0} by {1}",aB:"{0}: {1}"},export:{exportOne:"Export {0}",exportMany:"Export {0}",preview:"Export preview",header:"Header",options:"options",separator:"Separator",firstLine:"The first row is a header",format:"Export format",xpFields:"Fields to include in the export",IDkey:"ID",allFields:"Show all fields",formatCSV:"Comma separated values (CSV, TXT, XLS...)",formatHTML:"HTML",formatSQL:"SQL Insert Statements (SQL)",formatTAB:"Tab separated values (TXT)",formatXML:"XML",formatJSON:"Javascript Object Notation (JSON)",XMLroot:"Element name",headerLabels:"Field Labels",headerIds:"Field Attributes or Ids",db:"Database",SQL:"SQL Options",SQLTable:"Table name",SQLTrans:"In transaction",SQLIdInsert:"Identity insert",DownloadEntity:"Download {0}"},import:{importOne:"Import {0}",importMany:"Import {0}",format:"Source Format",fSample:"Sample",allowDups:"Allow duplicates",data:"Data to Import",success:"Import done.",empty:"Nothing to Import."},filters:{sEqual:"equals",sNotEqual:"not equal",sStart:"starts with",sContain:"contains",sNotContain:"doesn't contain",sFinish:"finishes with",sInList:"is any of",sIsNull:"is empty",sIsNotNull:"is not empty",sBefore:"before",sAfter:"after",sNumEqual:"&#61;",sNumNotEqual:"!&#61;",sGreater:"&#62;",sSmaller:"&#60;",sOn:"on",sNotOn:"not on",sAt:"at",sNotAt:"not at",sBetween:"between",opAnd:"and",yes:"Yes",no:"No",bNewCond:"New filter condition",bAddCond:"Add condition",bUpdateFilter:"Update filter",bSubmit:"Submit",bCancel:"Cancel"}},(Evol=Evol||{}).Def=function(){var l={text:"text",textml:"textmultiline",bool:"boolean",int:"integer",dec:"decimal",money:"money",date:"date",datetime:"datetime",time:"time",lov:"lov",list:"list",html:"html",formula:"formula",email:"email",pix:"image",url:"url",color:"color",hidden:"hidden",json:"json"};return{fieldTypes:l,isViewMany:function(e){return this.isViewCollection(e)||this.isViewCharts(e)},isViewCollection:function(e){return"list"===e||"cards"===e},isViewCharts:function(e){return"charts"===e||"bubbles"===e||"scatter"===e||"sunburst"===e},fieldInCharts:function(e){return(_.isUndefined(e.inCharts)||e.inCharts)&&Evol.Def.fieldChartable(e)},fieldChartable:function(e){return e.type===l.lov||e.type===l.bool||e.type===l.int||e.type===l.money},fieldIsNumber:function(e){return e.type===l.int||e.type===l.dec||e.type===l.money},fnSearch:function(t,n){var a=t.fnSearch;return _.isFunction(a)?function(e){return t.fnSearch(e,n)}:_.isArray(a)?function(e){for(var t=a.length,i=0;i<t;i++){var l=a[i];if(e.get(l)&&-1<e.get(l).toLowerCase().indexOf(n))return!0}return!1}:_.isString(a)?function(e){return!!e.get(fn)&&-1<e.get(fn).toLowerCase().indexOf(n)}:void 0},getFields:function(e,t){var i=[];return function t(e){e&&e.elements&&0<e.elements.length?_.each(e.elements,function(e){e.elements?"panel-list"!=e.type&&t(e):i.push(e)}):i.push(e)}(e),_.isFunction(t)&&(i=_.filter(i,t)),i},getFieldsHash:function(e){var t={};return _.each(e,function(e){t[e.id]=e}),t},getSubCollecs:function(e){var i={};return function t(e){"panel-list"===e.type?i[e.attribute]=e:"panel"!==e.type&&e.elements&&0<e.elements.length?_.each(e.elements,function(e){"panel-list"===e.type?i[e.attribute]=e:"panel"!==e.type&&t(e)}):i[e.attribute]=e}(e),i},countBy:function(e,t,i,l){var n,a,s=Evol.Def.fieldTypes,o=Evol.i18n,r=[],d=[];if(t.type===s.bool)for(a in groups=_.countBy(e,function(e){return!0===e.get(t.id)}),groups)n=groups[a],lb="true"===a?t.labelTrue||o.yes:t.labelFalse||o.no,r.push(n),d.push(lb+" ("+n+")");else for(a in groups=_.countBy(e,function(e){return e.get(t.id)}),groups)n=groups[a],_.isUndefined(a)?lb=o.na:""===a||"null"===a?lb=o.none:t.type===s.lov||t.type===s.list?t.list&&t.list.length&&t.list[0].icon?lb=Evol.Dico.lovItemTextNoPix(t,a):lb=Evol.Dico.lovItemText(t,a,Evol.hashLov,l):lb=a,r.push(n),d.push(lb+" ("+n+")");return chartType=t.typeChart||(t.type===s.lov?"pie":"bars"),i[t.id]={field:t,data:r,labels:d},{data:r,labels:d}},sampleDatum:function(e,t){switch(e.type){case l.bool:return!0;case l.date:return"2015-0"+(t+1)+"-"+(t+14);case l.datetime:return"2015-04-23T17:15";case l.time:return"14:30";case l.url:return"http://www.evolutility.org";case l.email:return"abc@abc.com";case l.int:return e.min?e.min+5+2*t:t;case l.dec:case l.money:return 10.2*(t+1);case l.lov:if(e.list&&e.list.length)return t<e.list.length?e.list[t].id:e.list[0].id;break;default:return i=t,String.fromCharCode(97+i)+String.fromCharCode(98+i)+String.fromCharCode(99+i)}var i}}}(),(Evol=Evol||{}).Format={capitalize:function(e){return e&&0<e.length?e.substring(0,1).toUpperCase()+e.substring(1):""},trim:function(e){return _.isString(e)&&""!==e?e.replace(/^\s+|\s+$/g,""):""},cr2br:function(e,t){return""===e||null===e||_.isUndefined(e)?"":(t?_.escape(e):e).replace(/[\r\n]/g,"<br>")},dateString:function(e){if(e&&(e=e.substring(0,10)),!_.isUndefined(e)&&null!==e){var t=e.split("-");if(1<t.length)return t[1]+"/"+t[2]+"/"+t[0]}return""},timeString:function(e){if(_.isUndefined(e)||null===e||""===e)return"";var t=e.split(":"),i=parseInt(t[0],10);return 12<i?i-12+":"+t[1]+" PM":i+":"+t[1]+" AM"},datetimeString:function(e){if(_.isUndefined(e)||null===e||""===e)return"";var t=e.split("T");return 1<t.length?this.dateString(t[0])+", "+this.timeString(t[1]):this.dateString(t[0])},jsonString:function(e,t){var i;try{i=_.isString(e)&&""!==e?$.parseJSON(_.unescape(e)):e}catch(e){alert("Error: format.jsonString"+e),i={error:"Evol.Format.jsonString"}}if(""===i)return i;var l=JSON.stringify(i,null,2);return t&&(l=this.cr2br(l)),l}},(Evol=Evol||{}).hashLov={},Evol.ViewAction={},Evol.DOM={html:{trTableEnd:"</tr></table>",TdTrTableEnd:"</td></tr></table>",clearer:'<div class="clearfix"></div>',emptyOption:'<option value=""> - </option>',glyphicon:"glyphicon glyphicon-",required:'<span class="evol-required">*</span>',buttonClose:'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'},label:function(e,t){return'<label for="'+e+'">'+t+"</label>"},fieldLabel:function(e,t){return'<div class="evol-field-label">'+this.label(e,t)+"</div>"},fieldLabelSpan:function(e,t){return'<span class="evol-field-label">'+this.label(e,t)+"</span>"},input:{formula:function(e,t,i){return'<div class="disabled evo-rdonly evol-ellipsis'+(e?'" id ="'+e:"")+'">'+(t.formula?t.formula(i):"")+"</div>"},text:function(e,t,i,l){var n='<input type="text" id="'+e;return t&&_.isString(t)&&(t=t.replace(/"/g,'"')),n+='" value="'+t,n+='" class="evo-field form-control '+(l||""),i&&(_.each(["id","min","max","maxLength","placeholder"],function(e){_.isUndefined(i[e])||(n+='" '+e+'="'+i[e])}),i.readonly&&(n+='" disabled="disabled')),n+='">'},textInt:function(e,t,i,l){var n='<input class="evo-field form-control" type="number" id="'+e+'" value="'+t;return _.isUndefined(i)||(n+='" min="'+i),_.isUndefined(l)||(n+='" max="'+l),n+='" maxlength="12">'},textM:function(e,t,i,l,n){return'<textarea id="'+e+'" class="evo-field form-control" rows="'+l+'"'+(n?" disabled":"")+">"+t+"</textarea>"},textMJSON:function(e,t,i,l){return'<textarea id="'+e+'" rows="'+i+'" class="evol-json evo-field form-control"'+(l?" disabled":"")+">"+Evol.Format.jsonString(t,!1)+"</textarea>"},myType:function(e,t,i){return'<input type="'+e+'" id="'+t+'" value="'+i+'" class="evo-field form-control" size="15">'},date:function(e,t){return this.myType("date",e,(t||"").substring(0,10))},dateTime:function(e,t){return this.myType("datetime-local",e,t)},time:function(e,t){return this.myType("time",e,t)},typeFlag:function(e){return'<span class="input-group-addon">'+e+"</span>"},color:function(e,t){return'<input type="color" id="'+e+'" value="'+t+'" size="15">'},colorBox:function(e,t,i){return'<div class="evo-color-box" id="'+e+'" style="background-color:'+t+'" title="'+t+'">'+(i?"<span>"+i+"</span>":"")+"</div>"},checkbox:function(e,t){return'<input type="checkbox" id="'+e+(t?'" checked="checked':"")+'" value="1">'},checkbox2:function(e,t,i){return'<input type="checkbox" data-id="'+e+'" class="'+i+'"'+(t?' checked="checked"':"")+' value="1">'},checkboxLOV:function(e){return _.map(e,function(e){return'<input type="checkbox" id="'+e.id+'" value="'+e.id+'"/><label for="'+e.id+'">'+e.text+"</label> "}).join("")},radio:function(e,t,i,l,n){return'<label for="'+n+'"><input id="'+n+'" name="'+e+'" type="radio" value="'+t+(l?'" checked="checked':"")+'">'+i+"</label>&nbsp;"},lov:function(e,t,i,l){var n='<select class="evo-field form-control" id="'+e+'">';return i&&(n+='<option value="'+t+'" selected>'+i+"</option>"),opt=this.option,_.each(l,function(e){n+=opt(e.id,e.text)}),n+="</select>"},img:function(e,t,i){return'<img id="'+e+'" src="'+t.replace(/"/g,'"')+(i?'" class="'+i:"")+'">'},hidden:function(e,t){return'<input type="hidden" name="'+e+'" id="'+e+'" value="'+t.replace(/"/g,'"')+'"/>'},selectBegin:function(e,t,i){return'<select id="'+e+'" class="form-control '+t+'">'+(i?Evol.DOM.html.emptyOption:"")},select:function(e,t,i,l,n){return this.selectBegin(e,i,l)+this.options(n,t)+"</select>"},option:function(e,t,i){return'<option value="'+e+(i?'" selected':'"')+">"+t+"</option>"},options:function(e,t){var i=this.option,l="";return _.each(e,function(e){e.id===t?l+='<option value="'+e.id+'" selected="selected">'+e.text+"</option>":l+=i(e.id,e.text)}),l}},toggleCheckbox:function(e,t){t?e.prop("checked","checked"):e.prop("checked",!1)},button:function(e,t,i){return'<button type="button" data-id="'+e+'" class="btn'+(i?" "+i:"")+'">'+t+"</button>"},buttonsIcon:function(e,t){return'<div data-id="'+e+'" class="'+this.html.glyphicon+t+'" tabindex="0"></div>'},buttonsPlus:function(){return this.buttonsIcon("bPlus","plus-sign")},buttonsMinus:function(){return this.buttonsIcon("bMinus","minus-sign")},buttonsPlusMinus:function(){return this.buttonsPlus()+this.buttonsMinus()},link:function(e,t,i,l){var n='<a class="evo-field" href="'+encodeURI(i);return e&&(n+='" id="'+e),l&&(n+='" target="'+l),n+='">'+_.escape(t)+"</a>"},linkEmail:function(e,t){return t?this.link(e,t,"mailto:"+t):""},icon:function(e,t){return'<i class="'+(t?t+" ":"")+Evol.DOM.html.glyphicon+e+'"></i>'},iconId:function(e,t,i){return'<i class="'+this.html.glyphicon+i+'" data-id="'+e+(t?'" data-type="'+t:"")+'"></i>'},htmlIcon:function(e,t,i){return'<div class="glyphicon '+i+'" data-id="'+e+'" data-ctype="'+t+'"></div>'},menu:{hBegin:function(e,t,i,l,n){var a="<"+t+' class="dropdown" data-id="'+e+(n?'" data-cardi="'+n:"")+'"><a href="#" class="dropdown-toggle" data-toggle="dropdown">';return l&&(a+=l),i&&(a+=Evol.DOM.icon(i)),a+=' <b class="caret"></b></a><ul class="dropdown-menu evo-dropdown-icons">'},hEnd:function(e){return"</ul></"+e+">"},hItem:function(e,t,i,l,n){var a='<li data-id="'+e;return l&&(a+='" data-cardi="'+l),a+='" data-balloon-pos="down" data-balloon="'+t,a+='"><a href="javascript:void(0);" data-id="'+e+'">'+Evol.DOM.icon(i),a+="</a></li>"}},modal:{alert:function(e,t){var i=$(this.HTMLModal("alert",e,t,[{id:"ok",text:Evol.i18n.tools.bOK,class:"btn-primary"}])).on("click","button",function(e){i.remove()}).modal("show")},confirm:function(e,t,i,l,n){var a=$(this.HTMLModal(e,t,i,n)).on("click","button",function(e){var t=$(e.currentTarget).data("id");l&&l[t]&&l[t](),a.remove()}).modal("show")},HTMLModal:function(e,t,i,l){var n='<div class="modal fade" id="'+e+'" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button><h4 class="modal-title">'+t+'</h4></div><div class="modal-body">'+i+'</div><div class="modal-footer">';return l||(l=[{id:"cancel",text:Evol.i18n.tools.bCancel,class:"btn-default"},{id:"ok",text:Evol.i18n.tools.bOK,class:"btn-primary"}]),_.each(l,function(e){n+=function(e,t,i){return'<button data-id="'+e+'" type="button" class="btn '+i+'" data-dismiss="modal">'+t+"</button>"}(e.id,e.text,e.class)}),n+="</div></div></div></div>"}},panelBegin:function(e,t,i){var l='<div class="panel '+(e.css?e.css:t);return e.id&&(l+='" data-pid="'+e.id),l+='">',(e.label||e.label2)&&(l+=this.panelHeader(e,i)),l},panelHeader:function(e,t){return e.label||e.label2?'<div class="panel-heading '+(e.cssLabel?e.cssLabel:"")+'">'+(!1!==t?this.icon("chevron-up","evol-title-toggle"):"")+'<h3 class="panel-title">'+e.label+"</h3>"+(e.label2?'<div class="evol-subtitle">'+e.label2+"</div>":"")+(e.help?'<p class="evo-panel-help">'+e.help+"</p>":"")+"</div>":""},panelEnd:function(){return"</div>"},panelEmpty:function(e,t,i){return'<div data-id="'+e+'" class="'+t+" panel panel-"+i+'"></div>'},HTMLMsg:function(e,t,i){return'<div data-id="msg" class="evo-msg alert alert-'+(i||"info")+' alert-dismissable">'+this.html.buttonClose+"<strong>"+e+"</strong> <span>"+t+"</span></div>"},showOrHide:function(e,t){e?t?e.show():e.hide():console.log('ERROR: invalid element in "showOrHide".')},addRemClass:function(e,t,i){return t?e.addClass(i):e.removeClass(i),t},scroll2Top:function(){window.scrollTo(0,0)}},Evol.DOM.Charts={colors:["1f77b4","ff7f0e","2ca02c","d62728","9467bd","8c564b","e377c2","7f7f7f","bcbd22","17becf"],_colorsList:function(e){return this.colors.slice(0,e).join(",")},URL:"http://chart.apis.google.com/chart",_HTML:function(e,t,i){return'<div class="evol-chart-title">'+e+'</div><img src="'+t+'">'},Pie:function(e,t,i,l,n){var a=n||"390x200",s=this.URL+"?chd=t:"+t.join(",")+"&chco="+this._colorsList(t.length)+"&amp;chl="+i.join("|")+"&amp;cht=p&amp;chs="+a;return this._HTML(e,s,l||"panel-default")},Bars:function(e,t,i,l,n){var a=n||"360x200",s=_.max(t),o=this.URL+"?chbh=a&amp;chs="+a+"&cht=bvg&chco="+this._colorsList(t.length)+"&chds=0,"+s+"&amp;chd=t:"+t.join("|")+"&amp;chp=0.05&amp;chts=676767,10.5&amp;chdl="+i.join("|");return this._HTML(e,o,l)}},(Evol=Evol||{}).Dico=function(){var s=Evol.DOM,d=s.input,a=Evol.i18n,c=Evol.Def.fieldTypes;return{fieldEdit:{field:function(e,t,i,l){return d[t](i,l,e,null)},default:function(e,t,i){return d.text(t,i,e,null)},text:function(e,t,i){return d.text(t,i,e,null)},textmultiline:function(e,t,i){null===e.height?e.height=5:parseInt(e.height,10)<1&&(e.height=5);return d.textM(t,i,e.maxlength,e.height)},boolean:function(e,t,i){return d.checkbox(t,i)},integer:function(e,t,i){return d.textInt(t,i,e.max,e.min)},decimal:function(e,t,i){return d.textInt(t,i,e.max,e.min)},money:function(e,t,i){return'<div class="input-group evol-money">'+d.typeFlag("$")+d.textInt(t,i,e.max,e.min)+"</div>"},date:function(e,t,i){return d.date(t,i)},datetime:function(e,t,i){return d.dateTime(t,i)},time:function(e,t,i){return d.time(t,i)},lov:function(e,t,i){return d.select(t,i,"",!0,e.list)},list:function(e,t,i){return'<div id="'+t+'" class="w-100 form-control"></div>'},email:function(e,t,i){return'<div class="input-group">'+d.typeFlag(a.msg.sgn_email)+d.text(t,i,e)+"</div>"},url:function(e,t,i){return d.text(t,i,e)},image:function(e,t,i,l){var n="";return n+=""!==i?'<img src="'+(".."===i.substr(0,2)?i:l+i)+'" class="img-thumbnail">':'<p class="">'+a.nopix+"</p>",n+=d.text(t,i,e,null)},color:function(e,t,i){return d.color(t,i)},hidden:function(e,t,i){return d.hidden(t,i)},html:function(e,t,i){return d.textM(t,i,e.maxlength,e.height)},json:function(e,t,i){return d.textM(t,i,e.maxlength,e.height)},formula:function(e,t,i){return'<div class="evol-ellipsis">'+d.text(t,i,e,null)+"</div>"}},fieldHTML:function(e,t,i,l,n,a){var s,o="";if(a||(o+=this.HTMLFieldLabel(e,l||"edit")),e.readonly||"browse"===l){switch(o+='<div class="disabled evo-rdonly'+(e.type===c.email||e.type===c.url?" evol-ellipsis":"")+'" id="'+t,e.type===c.textml&&1<e.height&&(o+='" style="height:'+((s=parseInt(e.height||2,10))<2&&(s=2),parseInt(1.6*s,10))+"em;overflow-y: auto;"),o+='">',e.type){case c.formula:o+='<div id="'+t+'" class="form-control evol-ellipsis">'+e.formula()+"</div>";break;case c.color:o+='<div id="'+t+'" class="form-control">'+d.colorBox(t,i)+"</div>";break;default:o+=this.fieldHTML_RO(e,i,{},n)}o+="&nbsp;</div>"}else{var r=Evol.Dico.fieldEdit[e.type];r||(r=Evol.Dico.fieldEdit.default),o+=r(e,t,i,n)}return o},fieldHTML_RO:function(t,e,i,l,n){switch(t.type){case c.bool:if("true"===e||"1"==e)return s.icon("ok",t.css);break;case c.lov:if(""!==e)return Evol.Dico.lovItemText(t,e,i,l);break;case c.list:return _.isString(e)&&""!==e&&(e=e.split(",")),e&&e.length&&""!==e[0]?'<div class="evo-f-list"><div>'+_.map(e,function(e){return Evol.Dico.lovItemText(t,e,i,l)}).join("</div><div>")+"</div></div>":"";case c.date:case c.time:case c.datetime:return Evol.Format[t.type+"String"](e);case c.pix:if(e&&e.length)return d.img(t.id,l+e,"img-thumbnail");break;case c.money:var a=parseFloat(e);if(!isNaN(a))return"$"+a.toFixed(2);break;case c.email:return s.linkEmail(n?t.id:null,e);case c.url:return s.link(t.id,e,e,t.id);case c.json:return s.input.textM(t.id,Evol.Format.jsonString(e,!1),t.maxLen,t.height,!0);default:return e}return""},HTMLFieldLabel:function(e,t){var i='<div class="evol-field-label" id="'+e.id+'-lbl"><label class="control-label '+(e.cssLabel?e.cssLabel:"")+'" for="'+e.id+'">'+e.label;return"browse"!=t&&e.required&&(i+=s.html.required),e.help&&""!==e.help&&(i+=s.icon("question-sign","")),i+="</label></div>"},fieldLink:function(e,t,i,l,n,a){var s="";if(!n){s+='<a href="'+(a||"javascript:void(0);"),e&&(s+='" id="'+e),s+='" class="evol-nav-id">'}return l&&(s+='<img class="evol-many-icon" src="'+l+'">'),s+="<span>"+i+"</span>",n||(s+="</a>"),s},clearCacheLOV:function(){Evol.hashLov={}},setViewTitle:function(e,t,i){return e.titleSelector&&$(e.titleSelector).html((e.icon?'<i class="glyphicon glyphicon-'+e.icon+'"></i>&nbsp;':"")+(t||e.getTitle())+(i?'<span class="badge badge-one">'+i+"</span>":"")),e},getFieldVal:function(e,t){switch(e.type){case c.bool:return t.prop("checked");case c.int:return parseInt(t.val(),10);case c.dec:case c.money:return parseFloat(t.val());case c.list:try{return t.select2("val")}catch(e){return console.error("error with select2"),""}break;case c.date:var i=t.val();return 10===i.length&&(i+="T08:00:00.000Z"),i;default:return t.val()}},lovItemText:function(e,t,i,l,n){if(e.list&&0<e.list.length&&i){e.id in i||(i[e.id]={});var a=i[e.id];if(t in a)return a[t];var s=_.find(e.list,function(e){return e.id==t});if(s){var o=_.escape(s.text);return s.glyphicon?o='<i class="glyphicon glyphicon-'+s.glyphicon+'"></i> '+o:s.icon&&(o='<img src="'+(s.icon&&"."!==s.icon.substring(0,1)?l:"")+s.icon+'"> '+o),a[t]=o}}return""},lovItemTextNoPix:function(e,t){var i=_.find(e.list,function(e){return e.id==t});return i?i.text:""},filterModels:function(e,r){if(r.length){var d=Evol.Dico.fieldConditions;return e.filter(function(e){for(var t=0,i=r.length;t<i;t++){var l=r[t],n=e.get(l.field.value);if(_.isArray(n)){for(var a=n.length,s=!1,o=0;o<a;o++)if(d[l.operator.value](n[o],l.value.value)){s=!0;break}if(!s)return s}else if(_.isUndefined(n)&&(n=""),!d[l.operator.value](n,l.value.value,l.value.value2))return!1}return!0})}return e},bbComparator:function(t){return function(e){return e.get(t)}},bbComparatorText:function(i){return function(e,t){return(e.get(i)||"").localeCompare(t.get(i)||"")}},bbComparatorFormula:function(e,n){return function(e,t){var i=n(e),l=n(t);return i<l?1:l<i?-1:0}},sortNumber:function(i){return function(e,t){return e[i]<t[i]?1:t[i]<e[i]?-1:0}},sortText:function(i){return function(e,t){return(e[i]||"").localeCompare(t[i]||"")}},setPageTitle:function(e){_.isUndefined(this._$headTitle)&&(this._$headTitle=$("#headTitle")),this._$headTitle.html(e)},getItemTitle:function(e){return e.find("h4>a>span").text()},getRoute:function(){var e=window.location.href,t=e.indexOf("#");return-1<t?e.substr(t+1):""},setRoute:function(e,t,i,l,n){if(!_.isUndefined(e)){var a=t+"/"+i;l&&(a+="/"+l),a!==this.getRoute()&&e.navigate("#"+a,{trigger:n})}},fieldConditions:{eq:function(e,t){return t==e},ne:function(e,t){return t!=e},gt:function(e,t){return t<e},lt:function(e,t){return e<t},bw:function(e,t,i){return!(e<t||i<e)},sw:function(e,t){return e.substring(0,t.length).toLocaleLowerCase()===t},ct:function(e,t){return!!e&&-1<e.toLocaleLowerCase().indexOf(t)},nct:function(e,t){return!e||-1===e.toLocaleLowerCase().indexOf(t)},fw:function(e,t){var i=e.length,l=t.length;return!(i<l)&&e.toLocaleLowerCase().substring(i-l)===t},null:function(e,t){return""===e||_.isUndefined(e)},nn:function(e,t){return!(_.isUndefined(e)||""===e)},in:function(e,t){if(_.isArray(e)){for(var i=t.split(","),l=0;l<e.length;l++)if(_.contains(i,e[l]))return!0;return!1}return _.contains(t.split(","),e)},1:function(e,t){return e},0:function(e,t){return!e}}}}(),(Evol=Evol||{}).ViewMany={menuOne:[{id:"edit",type:null,icon:"edit"},{id:"delete",type:null,icon:"trash"}],eventsMany:{"click .pagination>li":"click_pagination","click .evol-actions>i,.evol-actions-nxtTd>i":"clickAction","change .list-sel":"click_selection",'change [data-id="cbxAll"]':"click_checkall"},actionEvents:{enterItem:function(l,n,a){return function(e){var t=$(e.currentTarget),i="evol-actions";n&&(t=n(t)),a&&t.width()<190&&t.siblings().length>t.index()&&(t=t.next(),i="evol-actions-nxtTd"),t.append('<div class="'+i+'">'+_.map(l,function(e){return Evol.DOM.iconId(e.id,e.type,e.icon)}).join("")+"</div>")}},leaveItem:function(e){$(e.currentTarget).find(".evol-actions,.evol-actions-nxtTd").remove()}}},Evol.View_Many=function(){var t=Evol.DOM,r=Evol.Dico,a=Evol.i18n;return Backbone.View.extend({viewName:"Many",viewType:"many",cardinality:"n",options:{style:"panel-default",pageSize:20,pageIndex:0,autoUpdate:!1,links:!0,noDataString:a.nodata,iconsPath:"pix/",fieldsetFilter:function(e){return e.inMany}},events:Evol.ViewMany.eventsMany,initialize:function(e){var t=localStorage.getItem(e.uiModel.id+"-sort"),i=this;if(_.extend(this,this.options,e),this.mode=this.mode||"",this._filter=[],this.autoUpdate&&this.collection&&this.collection.on("change",function(){i.render()}),this.router||this.$el.on("click",".evol-nav-id",function(e){i.click_navigate(e)}),null!==t){var l=t.split("-"),n=this.getField(l[0]);1<l.length&&!_.isUndefined(n)&&this.sortList(n,"down"===l[1],!0,!0)}},render:function(){var e=this.collection?this.collection.models:null;return this.collection&&this.collection.length?(e=r.filterModels(e,this._filter),this._render(e)):this.$el.html(t.HTMLMsg(this.noDataString,"","info")),this.setTitle()},_HTMLbody:function(e,t,i,l,n){var a=[],s=this.collection.models,o=0<l?l*t:0,r=_.min([s.length,o+t]),d=i?(this.iconsPath||"")+i:null;if(0<r)for(var c=this.getItemRoute(),u=o;u<r;u++)this.HTMLItem(a,e,s[u],d,n,c);return a.join("")},_render:function(e){alert("_render must be overridden")},_HTMLField:function(e,t){if("formula"!==e.type)return r.fieldHTML_RO(e,t,Evol.hashLov,this.iconsPath||"");var i='<div class="disabled evo-rdonly evol-ellipsis">';return e.formula&&this.model&&(i+=e.formula(this.model)),i+="</div>"},_HTMLCheckbox:function(e){return t.input.checkbox2(e,!1,"list-sel")},setCollection:function(e){return this.collection=e,this.render()},getCollection:function(){return this.collection},setFilter:function(e){return this._filter=e,this},getFilter:function(){return this._filter},setTitle:function(e){return r.setViewTitle(this,e||this.getTitle())},getTitle:function(){return Evol.Format.capitalize(this.uiModel.namePlural)+" "+this.viewName},getFields:function(){if(!this._fields){this._fields=Evol.Def.getFields(this.uiModel,this.fieldsetFilter),this._fieldHash={};var t=this._fieldHash;_.each(this._fields,function(e){t[e.id]=e})}return this._fields},getField:function(e){return this._fieldHash||this.getFields(),this._fieldHash[e]},setPage:function(e){var t=this.getFields(),i=this.pageSize,l=this.collection.length,n=this._pageSummary(e,i,l);return this._$body().html(this._HTMLbody(t,i,this.uiModel.icon,e,this.selectable)),this.$(".evo-pagination").html(this._HTMLpaginationBody(e,i,l)),this.$(".evo-many-summary").html(n),this.pageIndex=e,this.$el.trigger("status",n),this},getPage:function(){return this.pageIndex},_$Selection:function(){return this.$(".list-sel:checked").not('[data-id="cbxAll"]')},getSelection:function(){return this.selectable?_.map(this._$Selection().toArray(),function(e){return $(e).data("id")}):[]},setSelection:function(e){if(this.selectable&&0<e.length){var t=[];_.each(e,function(e){t.push("[data-mid="+e+"] .list-sel")}),this.$(t.join(",")).prop("checked",!0)}return this},pageSummary:function(){return this._pageSummary(this.pageIndex,this.pageSize,this.collection.length)},_pageSummary:function(e,t,i){if(0===i)return"";if(1===i)return i+" "+this.uiModel.name;if(i<=t)return i+" "+this.uiModel.namePlural;var l,n=(e||0)*t+1;return l=e<1?_.min([t,i]):_.min([n+t-1,i]),a.range.replace("{0}",n).replace("{1}",l).replace("{2}",i).replace("{3}",this.uiModel.namePlural)},_HTMLpagination:function(e,t,i){return t<i?'<ul class="evo-pagination pagination pagination-sm">'+this._HTMLpaginationBody(e,t,i)+"</ul>":""},_HTMLpaginationBody:function(e,t,i){var l="";if(t<i){function n(e){l+="<li"+(d===e?' class="active"':"")+' data-id="'+e+'"><a href="javascript:void(0)">'+e+"</a></li>"}function a(e,t){for(var i=e;i<=t;i++)n(i)}function s(){l+='<li class="disabled"><a href="javascript:void(0)">...</a></li>'}var o,r=Math.ceil(i/t),d=e+1;l+='<li data-id="prev"'+(1===d?' class="disabled"':"")+'><a href="javascript:void(0)">&lt;</a></li>',n(1),4<d&&6<r?(5===d?n(2):s(),o=_.min([d+2,r]),a(_.max([2,d-2]),o)):a(2,o=_.min([_.max([5,d+2]),r])),o<r&&d+2<r&&(s(),n(r)),l+='<li data-id="next"'+(d<r?"":' class="disabled"')+'><a href="javascript:void(0)">&gt;</a></li>'}return l},sortList:function(e,t,i,l){var n=this.collection,a=Evol.Def.fieldTypes;if(!_.isUndefined(n)){var s=this.getSelection();e.type==a.text||e.type==a.textml||e.type==a.email?n.comparator=r.bbComparatorText(e.id):e.type===a.formula?n.comparator=r.bbComparatorFormula(e.id,e.formula):n.comparator=r.bbComparator(e.id),n.sort(),t&&n.models.reverse(),this.setPage(0);var o=t?"down":"up";i||localStorage.setItem(this.uiModel.id+"-sort",e.id+"-"+o),this.setSelection(s),l||this.$el.trigger("sort.many",{id:e.id,direction:o})}return this},getItemRoute:function(){return this.router?"#"+this.uiModel.id+"/browse/":null},click_navigate:function(e){var t=$(e.currentTarget).closest("[data-mid]").data("mid");e.type="navigate.many",this.$el.trigger(e,{id:t})},click_pagination:function(e){this.$el.trigger("paginate.many",{id:$(e.currentTarget).closest("li").data("id")})},click_selection:function(e){this.$el.trigger("selection.many")},click_checkall:function(e){var t=this.$('[data-id="cbxAll"]').prop("checked");this.$(".list-sel").prop("checked",t),this.$el.trigger("selection.many")}})}(),(Evol=Evol||{}).Bubbles=function(){function e(e){for(var t in _.extend(this,e),this.fieldsH={},this.fields){var i=this.fields[t];this.fieldsH[i.id]=i}return this}Evol.Def.fieldTypes;return e.prototype._initialize=function(){this.graphInitialized||(this.svg=d3.select(this.elem).append("svg").attr("width",this.width).attr("height",this.height),this.force=d3.layout.force(),this.graphInitialized=!0)},e.prototype.fixData=function(e){return _.map(e,function(e){return e})},e.prototype.setData=function(e){var i=this,t=e.length,l=t<17?20:t<100?16:10;if(this.defaultSize=l,this.sizeFieldId){var n=_.map(e,function(e){var t=e[i.sizeFieldId];return null!==t&&!_.isNaN(t)||(t=0),t});this.plotScale=d3.scale.log().domain([_.min(n),_.max(n)]).range([l,20+l])}else this.plotScale=function(e){return l};this.fill=t<11?d3.scale.category10():d3.scale.category20(),this.data=e;for(var a=0;a<e.length;a++)e[a].radius=l,e[a].x=Math.random()*this.width,e[a].y=Math.random()*this.height;function s(){$(".popover").each(function(){$(this).remove()})}this._initialize(),this.maxRadius=d3.max(_.pluck(e,"radius")),this.nodes=this.svg.selectAll("circle").data(e),this.nodes.enter().append("circle").attr("class","node").attr("data-mid",function(e){return e.id}).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}).attr("r",function(e){return e.radius}).style("fill",function(e){return i.fill(e[i.colorFieldId])}).on("mouseenter",function(e){$(this).popover({animation:!0,placement:"auto top",container:"body",trigger:"manual",html:!0,content:i.tooltip(e)}),$(this).popover("show",500),d3&&d3.select(".popover").style("opacity",0).transition().duration(500).style("opacity",1)}).on("mouseleave",s).on("click",s),this.nodes.attr("data-mid",function(e){return e.id}).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y}).attr("r",function(e){return e.radius}).style("fill",function(e){return i.fill(e[i.colorFieldId])}),this.nodes.exit().remove(),this.changeBubblesSize(this.sizeFieldId),this.changeBubblesGroup(this.groupFieldId)},e.prototype.getCenters=function(e,t,i){var l,n=this.fieldsH[e];if(l=_.uniq(_.pluck(i,e)).map(function(e){return{name:e,value:1}}),n)if("lov"===n.type){var a={};_.forEach(n.list,function(e){a[e.id]=e.text}),_.forEach(l,function(e){e.label=a[e.name]||"N/A"}),l=l.sort(Evol.Dico.sortText("label"))}else if("boolean"===n.type)_.forEach(l,function(e){!0===e.name?e.label=n.labelTrue||Evol.i18n.yes:!1===e.name?e.label=n.labelFalse||Evol.i18n.no:e.label="N/A"});else if(Evol.Def.fieldIsNumber(n)){l=l.sort(Evol.Dico.sortNumber("name"));var s=_.findWhere(l,{name:null});s&&(s.label="N/A")}return d3.layout.treemap().size(t).ratio(1).nodes({children:l}),l},e.prototype.changeBubblesGroup=function(e){var t=this.getCenters(e,[800,600],this.data);this.groupFieldId=e,this.force.on("tick",this.tick(t,e,this.data)),this.labels(t),this.force.start()},e.prototype.changeBubblesColor=function(t){var i=this;this.colorFieldId=t,this.fill=d3.scale.category10(),this.svg.selectAll("circle").transition().duration(500).style("fill",function(e){return t?i.fill(e[t]):"rgb(31, 119, 180)"})},e.prototype.changeBubblesSize=function(i){var l=this;this.sizeFieldId=i;var e=this.svg.selectAll("circle");if(i){var t=_.map(this.data,function(e){var t=e[i];return null===t||t===isNaN||_.isUndefined(t)?0:t});this.plotScale=d3.scale.log().domain([_.min(t),_.max(t)]).range([10,25]),e.transition().duration(500).attr("r",function(e){var t=i?l.plotScale(e[i]||0):10;return null!==t&&!_.isNaN(t)||(t=l.defaultSize),t})}else e.transition().duration(500).attr("r",l.defaultSize)},e.prototype.tick=function(e,n){for(var a=this,s={},t=0;t<e.length;t++)s[e[t].name]=e[t];return function(e){for(var t=0;t<a.data.length;t++){var i=a.data[t],l=s[i[n]];i.y+=(l.y+l.dy/2-i.y)*e.alpha,i.x+=(l.x+l.dx/2-i.x)*e.alpha}a.nodes.each(a.collide(.12,a.data)).attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y})}},e.prototype.labels=function(e){this.svg.selectAll(".label").remove(),this.svg.selectAll(".label").data(e).enter().append("text").attr("class","label").text(function(e){return e.label||e.name}).attr("transform",function(e){return"translate("+(e.x+e.dx/2)+", "+(e.y+20)+")"})},e.prototype.collide=function(f,e){var t=d3.geom.quadtree(e),i=this.maxRadius;return function(d){var e=d.radius+i+2,c=d.x-e,u=d.x+e,h=d.y-e,v=d.y+e;t.visit(function(e,t,i,l,n){if(e.point&&e.point!==d){var a=d.x-e.point.x,s=d.y-e.point.y,o=Math.sqrt(a*a+s*s),r=d.radius+e.point.radius+2;o<r&&(o=(o-r)/o*f,d.x-=a*=o,d.y-=s*=o,e.point.x+=a,e.point.y+=s)}return u<t||l<c||v<i||n<h})}},e}(),Evol.ViewMany.Bubbles=Evol.View_Many.extend({viewName:"bubbles",icon:"adjust",events:{"click .btn":"clickGroup","change .bubble-group":"changeGroup","change .bubble-color":"changeColor","change .bubble-size":"changeSize","click svg>circle":"clickCircle"},fieldsetFilter:Evol.Def.fieldChartable,setupBubbles:function(){var l=this,e=(this.uiModel,this.collection.models);if(!this._bubblesInitialized){var t=Evol.Def.getFields(this.uiModel,Evol.Def.fieldChartable),i=t.length?t[0].id:null;this.bubbles=new Evol.Bubbles({elem:this.$(".evol-bubbles-body").get(0),width:1200,height:700,fields:t,colorFieldId:i,groupFieldId:i,sizeFieldId:null,uiModel:this.uiModel,tooltip:function(e){var t=[],i=l.getFields();return Evol.ViewMany.Cards.prototype.HTMLItem.call(l,t,i,new Backbone.Model(e),null,null,null,!0),t.join("")}}),this.bubbles.setData(_.map(e,function(e){return _.extend({id:e.id},e.attributes)})),this._bubblesInitialized=!0}},_render:function(e){var t,i=Evol.DOM,l=Evol.i18n.tools,n=i.input.option,a=i.html.emptyOption,s=Evol.Def.getFields(this.uiModel,Evol.Def.fieldChartable),o='<div class="evol-many-bubbles panel '+this.style+'"><div class="evol-bubbles-body"><div class="d3-tooltip" style="opacity:0;"></div>';return o+='<div class="bubbles-opts '+this.style+'">',s.length?(o+="<label>"+l.vizGroupBy+": </label>",5<s.length?o+='<select class="form-control bubble-group">'+a+(t=_.map(s,function(e,t){return n(e.id,e.label,0===t)})).join("")+"</select>":o+='<div class="btn-group" data-toggle="buttons">'+_.map(s,function(e,t){if(_.isUndefined(e.groupable)||e.groupable)return'<label class="btn btn-default'+(0===t?" active":"")+'" id="'+e.id+'"><input type="radio" name="options"'+(0===t?" checked":"")+">"+e.label+"</label>"}).join("")+"</div>",t=_.map(s,function(e,t){return _.isUndefined(e.colorable)||e.colorable?n(e.id,e.label,0===t):""}),o+="<label>"+l.vizColorBy+': </label><select class="form-control bubble-color">'+a+t.join("")+"</select>",s=_.filter(s,function(e){return _.isUndefined(e.sizable)||e.sizable?Evol.Def.fieldIsNumber(e):""}),(t=_.map(s,function(e,t){return n(e.id,e.label)})).length&&(o+="<label>"+l.vizSizeBy+': </label><select class="form-control bubble-size">'+a+t.join("")+"</select>")):o+=Evol.i18n.notEnoughdata,o+="</div></div></div>",this.$el.html(o),this.setupBubbles(),this},_HTMLbody:function(){},_HTMLlegend:function(){},_$body:function(){return this.$(".evol-bubbles-body")},setCollection:function(e){return this.collection=e,this.bubbles.setData(_.map(e.models,function(e){return _.extend({id:e.id},e.attributes)})),this},clickGroup:function(e){this.bubbles.changeBubblesGroup(e.currentTarget.id)},changeGroup:function(e){this.bubbles.changeBubblesGroup(e.target.value)},changeColor:function(e){this.bubbles.changeBubblesColor(e.target.value)},changeSize:function(e){this.bubbles.changeBubblesSize(e.target.value)},clickCircle:function(e){var t=$(e.currentTarget).data("mid");this.$el.trigger("click.bubble",{id:t}),window.location.href="#"+this.uiModel.id+"/browse/"+t}}),Evol.ViewMany.Cards=Evol.View_Many.extend({viewName:"cards",icon:"th-large",events:_.extend({"mouseenter .evol-cards-body>div":"enterItem","mouseleave .evol-cards-body>div":"leaveItem"},Evol.ViewMany.eventsMany),fieldsetFilter:function(e){return e.inMany||e.inCards},_render:function(e){var t=this.pageSize||50,i=this.pageSummary(0,t,e.length);return this.$el.html('<div class="evol-many-cards"><div class="evol-cards-body">'+this._HTMLbody(this.getFields(),t,this.uiModel.icon,0,this.selectable)+"</div>"+Evol.DOM.html.clearer+this._HTMLpagination(0,t,e.length)+'<div class="evo-many-summary">'+i+"</div></div>"),this},_$body:function(){return this.$(".evol-cards-body")},HTMLItem:function(a,e,s,o,r,d,c){var u,h=this,v=Evol.Def.fieldTypes,f=!1!==this.links,p=Evol.DOM.input;return c?a.push('<div class="evol-bubble-tooltip">'):a.push('<div class="panel '+this.style+'">'),_.each(e,function(e,t){if(u=e.type===v.color?(u=s.escape(e.attribute||e.id),p.colorBox(e.id,u,u)):"formula"===e.type?p.formula(null,e,s):"image"!==e.type||c?e.type===v.json?s.get(e.attribute||e.id):h._HTMLField(e,s.escape(e.attribute||e.id)):'<a href="#'+d+s.id+'">'+h._HTMLField(e,s.escape(e.attribute||e.id))+"</a>",0===t){a.push('<div data-mid="'+s.id+'">');var i=h.uiModel.fnBadge;i&&(a.push('<span class="badge pull-right">'),_.isFunction(i)?a.push(i(s)):_.isString(i)&&a.push(s.escape(i)),a.push("</span>")),a.push("<h4>"+(r?h._HTMLCheckbox(s.id):"")+Evol.Dico.fieldLink(null,e,u,o,!f,d?d+s.id:null)+"</h4></div>")}else{var l=e.labelCards,n=e.type==v.email||e.type==v.url?'evol-ellipsis"':"";""===l?(n+=e.type==v.pix?'evol-c-center"':"",a.push("<div"+(n?' class="'+n+'"':"")+">"+u+"</div>")):(l||(l=e.labelMany||e.label),a.push('<div class="'+n+'"><label>'+l+":</label> "+u+"</div>"))}}),a.push("</div>"),this},enterItem:Evol.ViewMany.actionEvents.enterItem(Evol.ViewMany.menuOne),leaveItem:Evol.ViewMany.actionEvents.leaveItem,clickAction:function(e){var t=this,i=$(e.currentTarget),l=i.data("id"),n=i.parent().siblings().eq(0).data("mid"),a=i.closest(".panel");"edit"===l?this.$el.trigger("navigate",{id:n,view:l}):this.$el.trigger("action",{id:l,mid:n,title:Evol.Dico.getItemTitle(a),skipWarning:e.shiftKey,fnSuccess:function(e){a.fadeOut(500,function(){a.remove(),t.$el.trigger("status",t.pageSummary())})}})}}),Evol.ViewMany.Charts=function(){var v=Evol.DOM,f=(Evol.Dico,Evol.i18n);return Evol.View_Many.extend({viewName:"charts",icon:"stats",isChart:!0,options:{style:"panel-info",fieldsetFilter:Evol.Def.fieldInCharts,autoUpdate:!1},events:{"mouseenter .evol-many-charts>div":"enterItem","mouseleave .evol-many-charts>div":"leaveItem","click .evol-actions>i":"clickAction"},render:function(){return this.entityName=Evol.Format.capitalize(this.uiModel.namePlural),this.collection&&0<this.collection.length?this.$el.html('<div class="evol-many-'+this.viewName+'">'+this._HTMLcharts(this.style||"panel-info",this.sizes)+"</div>"):this.$el.html(v.HTMLMsg(f.nodata,"","info")),this.setTitle()},_HTMLcharts:function(n,a){var s,o="",r=Evol.Def.fieldTypes,d=(this.uiModel,this.collection.models),c=this.iconsPath||"",e=this.getFields(),u={},h=this.entityName;e&&e.length?(_.each(e,function(e){var t=Evol.Def.countBy(d,e,u,c),i=t.data,l=t.labels;e.type===r.lov||(e.type,r.list);s=e.typeChart||(e.type===r.lov?"pie":"bars"),o+='<div class="evol-chart-holder panel '+n+'"><div class="opts"></div><div class="chart-holder" data-fid="'+e.id+'" data-ctype="'+s+'">',"pie"===s?o+=v.Charts.Pie(e.labelCharts?e.labelCharts:f.getLabel("charts.aByB",h,e.label),i,l,n,a):"bars"===s&&(o+=v.Charts.Bars(e.labelCharts?e.labelCharts:f.getLabel("charts.aB",h,e.label),i,l,n,a)),o+="</div><br></div>"}),this._cData=u):o+=v.HTMLMsg(f.nochart,f.badchart);return o+=v.html.clearer},setPage:function(){},enterItem:Evol.ViewMany.actionEvents.enterItem([{id:"bars",type:null,icon:"stats"},{id:"pie",type:null,icon:"record"}]),leaveItem:Evol.ViewMany.actionEvents.leaveItem,clickAction:function(e){var t,i,l=$(e.currentTarget),n=l.data("id"),a=l.parent().parent().find(".chart-holder"),s=a.data("ctype"),o=a.data("fid"),r=this._cData[o],d=r.field,c=v.Charts;n!=s&&(i="bars"===n?(t="Bars","charts.aB"):(t="Pie","charts.aByB"),a.html(c[t](d.labelCharts?d.labelCharts:f.getLabel(i,this.entityName,d.label),r.data,r.labels,r.style,r.sizes)),a.data("ctype",n))}})}(),Evol.ViewMany.List=Evol.View_Many.extend({viewName:"list",icon:"th-list",events:_.extend({"mouseenter tbody>tr":"enterItem","mouseleave tbody>tr":"leaveItem","click .evol-sort-icons>i":"click_sort"},Evol.ViewMany.eventsMany),fieldsetFilter:function(e){return e.inMany||e.inList},_render:function(e){var t="",i=this,l=this.getFields(),n=this.pageSize||50,a=!1!==this.links;t+='<div class="evol-many-list"><div><table class="table'+(a?" table-hover":"")+'"><thead><tr>',this.selectable&&(t+='<th class="list-td-sel">'+this._HTMLCheckbox("cbxAll")+"</th>"),_.each(l,function(e){t+=i._HTMLlistHeader(e)}),t+="</tr></thead><tbody>"+this._HTMLbody(l,n,this.uiModel.icon,0,this.selectable)+"</tbody></table></div>"+this._HTMLpagination(0,n,e.length)+'<div class="evo-many-summary">'+this.pageSummary(this.pageIndex,n,e.length)+"</div></div>",this.$el.html(t)},_$body:function(){return this.$(".table > tbody")},HTMLItem:function(n,e,a,s,t,o){var r,d=this,c=d.uiModel.fnBadge,u=!1!==this.links,h=Evol.Def.fieldTypes,v=Evol.DOM.input;n.push('<tr data-mid="'+a.id+'">'),t&&n.push('<td class="list-td-sel">'+this._HTMLCheckbox(a.id)+"</td>"),_.each(e,function(e,t){var i;r=e.type===h.color?v.colorBox(e.id,a.escape(e.attribute||e.id)):e.type===h.formula?v.formula(null,e,a):e.type===h.json||e.type===h.html?a.get(e.attribute||e.id):d._HTMLField(e,a.escape(e.attribute||e.id)),0===t&&(r=Evol.Dico.fieldLink(null,e,r,s,!u,o?o+a.id:null),c&&(_.isFunction(c)?i=c(a)||"":_.isString(c)&&(i=a.escape(c)||""),i&&(r+='<span class="badge badge-list">'+i+"</span>")));var l=e.css||"";e.type===h.email||e.type===h.url?l+=" evol-ellipsis":e.type===h.pix?l+=" evol-td-pix":Evol.Def.fieldIsNumber(e)&&(l+=" evol-r-align"),n.push('<td class="'+l+'">'+r+"</td>")}),n.push("</tr>")},_HTMLlistHeader:function(e){var t='<th><span id="'+e.id+'-lbl">'+(e.labelList||e.labelMany||e.label);return!1!==e.sortable&&(t+='<span class="evol-sort-icons" data-fid="'+e.id+'">'+Evol.DOM.icon("chevron-up")+Evol.DOM.icon("chevron-down")+"</span>"),t+="</span></th>"},click_sort:function(e){var t=$(e.currentTarget),i=t.parent().data("fid"),l=this.getField(i),n=0<t.attr("class").indexOf("-down");this.sortList(l,n)},enterItem:Evol.ViewMany.actionEvents.enterItem(Evol.ViewMany.menuOne,function(e){return e.children().eq(0)},!0),leaveItem:Evol.ViewMany.actionEvents.leaveItem,clickAction:function(e){var t=this,i=$(e.currentTarget),l=i.data("id"),n=i.closest("tr"),a=n.data("mid");"edit"===l?this.$el.trigger("navigate",{id:a,view:l}):this.$el.trigger("action",{id:l,mid:a,title:i.closest("tr").find("a>span").text(),skipWarning:e.shiftKey,fnSuccess:function(e){n.fadeOut(500,function(){n.remove(),t.$el.trigger("status",t.pageSummary())})}})}}),(Evol=Evol||{}).ViewOne={},Evol.View_One=function(){var c=Evol.DOM,d=c.input,h=Evol.i18n,v=(h.tools,Evol.Def),u=Evol.Dico,f=v.fieldTypes;return Backbone.View.extend({viewName:"One",viewType:"one",cardinality:"1",editable:!0,events:{"click .evol-buttons>button":"click_button","click .evol-title-toggle":"click_toggle","click ul.evol-tabs>li>a":"click_tab","click label>.glyphicon-question-sign":"click_help",'click [data-id="bPlus"],[data-id="bMinus"]':"click_detailsAddDel",'keyup [data-id="bPlus"],[data-id="bMinus"]':"click_detailsAddDel"},options:{style:"panel-default",button_addAnother:!1,titleSelector:"#title",iconsPath:"pix/"},initialize:function(e){_.extend(this,this.options,e),this.mode=this.mode||this.viewName,this._tabId=!1,this._subCollecs=this._subCollecsOK=!1},render:function(){var e=[];return this._render(e,this.mode),this.$el.html(e.join("")),this.custOn=!1,this.postRender(),this.setData(this.model,!0),this},postRender:function(){},getFields:function(){if(!this._fields){this._fields=v.getFields(this.uiModel,this.fieldsetFilter),this._fieldHash=v.getFieldsHash(this._fields)}return this._fields},getFieldsHash:function(){return this._fields||this.getFields(),this._fieldHash},getSubCollecs:function(){return this._subCollecsOK||(this._subCollecs=v.getSubCollecs(this.uiModel),this._subCollecsOK=!0),this._subCollecs},setModel:function(e){return this.model=e,this.clearMessages().setData(e,!0)},getModel:function(){return this.model},setUIModel:function(e){return this.uiModel=e,this.clearCache().render()},getUIModel:function(){return this.uiModel},getData:function(e){var a=this,t=this.getFields(),s={},i=this.getSubCollecs();if(e){function l(e){return!0!==e.readonly}t=_.filter(t,l),i=_.filter(i,l)}return _.forEach(t,function(e){s[e.id]=a.getFieldValue(e)}),i&&i.length&&_.each(i,function(t){var i,l,e=a.$('[data-pid="'+t.id+'"] tbody tr').not('[data-id="nodata"]').toArray(),n=[];_.each(e,function(e){i={},l=$(e).children(),_.each(t.elements,function(e,t){i[e.id]=u.getFieldVal(e,l.eq(t).find("input,select,textarea").eq(0))}),n.push(i)}),s[t.attr||t.id]=n}),s},setData:function(i,l){if(_.isUndefined(i)||null===i)this.clear();else{var n,a,s,o=this,e=this.getSubCollecs(),r=this.iconsPath;_.each(this.getFields(),function(e){if(n=o.$field(e.id),a=l?i.get(e.attribute||e.id)||"":i[e.attribute||e.id]||"",e.readonly)switch(e.type){case f.pix:s=a?'<img src="'+r+a+'" class="img-thumbnail">':'<p class="">'+h.nopix+"</p>",n.val(a).prev().remove(),n.before(s);break;case f.textml:n.html(Evol.Format.cr2br(a,!0));break;case f.bool:case f.url:case f.email:case f.list:case f.lov:n.html(u.fieldHTML_RO(e,_.isUndefined(a)?"":a,Evol.hashLov,r)+" ");break;case f.formula:n.html(e.formula?e.formula(i):"");break;case f.color:n.html(d.colorBox(e.id,a,a));break;case f.json:n.val(Evol.Format.jsonString(a,!1));break;default:n.text(u.fieldHTML_RO(e,_.isUndefined(a)?"":a,Evol.hashLov,r)+" ")}else switch(e.type){case f.lov:var t=n.children().removeAttr("selected");""!==a&&t.filter("[value="+a+"]").prop("selected","selected");break;case f.bool:n.prop("checked",!!a&&"checked");break;case f.date:a&&(a=a.substring(0,10)),n.val(a);break;case f.pix:s=a?'<img src="'+r+a+'" class="img-thumbnail">':'<p class="">'+h.nopix+"</p>",n.val(a).prev().remove(),n.before(s);break;case f.list:try{n.select2("val",_.isString(a)?[a]:a)}catch(e){return console.error("error with select2"),""}break;case f.formula:n.html(e.formula?e.formula(i):"");break;case f.json:n.val(Evol.Format.jsonString(a,!1));break;default:n.val(a)}}),e&&_.forEach(e,function(e){var t=[];o._renderPanelListBody(t,e,a,e.readonly?"browse":"edit"),o.$('[data-pid="'+e.id+'"] tbody').html(t.join(""))})}return this.setTitle()},setDefaults:function(){var t=this;return this.clear(),_.each(this.getFields(),function(e){e.hasOwnProperty("defaultValue")&&t.setFieldValue(e.id,e.defaultValue)}),this},setFieldValue:function(e,t){return this.$field(e).val(t),this},getFieldValue:function(e){if(_.isString(e))return u.getFieldVal(this._fieldHash[e],this.$field(e));var t=u.getFieldVal(e,this.$field(e.id));if(e.type===f.json){var i;try{i=$.parseJSON(t)}catch(e){}return _.isUndefined(i)?t:i}if(e.type!==f.date)return u.getFieldVal(e,this.$field(e.id));var l=u.getFieldVal(e,this.$field(e.id));return 10===l.length?l+"T08:00:00.000Z":l},setFieldProp:function(e,t,i){if("value"===t)this.setFieldValue(e,i);else{var l=this.$field(e);switch(t){case"enabled":i?l.removeProp("disabled"):l.prop("disabled",!0);break;case"visible":c.showOrHide(l,i)}}return this},getFieldProp:function(e,t){if("value"===t)this.setFieldValue(e,value);else{var i=this.$field(e);switch(t){case"enabled":return!i.prop("disabled");case"visible":return i.is(":visible")}}},$field:function(e){return this.$("#"+this.fieldViewId(e))},clear:function(){var i,l,n=this,e=this.getSubCollecs();return this.clearMessages(),_.each(this.getFields(),function(e){if(i=n.$field(e.id),l=e.defaultValue||"",e.readonly)i.html(l);else switch(e.type){case f.bool:i.prop("checked",!!l&&"checked");break;case f.list:i.select2("val",l);break;case f.pix:var t="<p>"+h.nopix+"</p>";i.val("").prev().remove(),i.before(t);break;case f.formula:i.html("");break;default:i.val(l)}}),e&&_.each(e,function(e){n.$('[data-pid="'+e.id+'"] tbody').html(n._TRnodata(e.elements.length,"edit"))}),this},clearCache:function(){return this._fieldHash=null,this._fields=null,this._subCollecs=this._subCollecsOK=!1,this},getModelFieldValue:function(e,t,i){return this.model&&this.model.has(e)?"new"!==i?this.model.get(e):t||"":""},_showTab:function(e){var t=this.$(e);return 0<t.length&&(t.siblings(".tab-pane").removeClass("active").hide(),t.addClass("active").show()),0<(t=this.$('.evol-tabs > li > a[href="'+e+'"]').parent()).length&&(t.siblings("li").removeClass("active"),t.addClass("active").show()),this._tabId=e,this.$el.trigger("change.tab",{id:e}),this},_renderButtons:function(e,t){e.push(c.html.clearer+'<div class="evol-buttons panel '+this.style+'">'+c.button("cancel",h.tools.bCancel,"btn-default")+c.button("save",h.tools.bSave,"btn-primary")),this.model&&this.model.isNew()&&this.button_addAnother&&"json"!==t&&e.push(c.button("save-add",h.tools.bSaveAdd,"btn-default")),e.push("</div>")},_render:function(i,l){var n=this,a=-1,s=-1,o=this.uiModel.elements;i.push('<div class="evo-one-'+l+'">'),_.each(o,function(e,t){"tab"===e.type?(0<s&&(i.push("</div>"),s=-1),a<0&&(i.push(c.html.clearer),n._renderTabTitles(i,o),i.push('<div class="tab-content">')),a++,i.push('<div id="evol-tab-'+t+'" class="tab-pane'+(0===a?' active">':'" style="display:none;">')),n._renderTab(i,e,l)):(s<0&&(i.push('<div class="evol-pnls">'),s=1),e.id||(e.id="p"+t),"panel-list"===e.type?n._renderPanelList(i,e,l):n._renderPanel(i,e,l))}),0<a&&i.push("</div>"),0<s&&i.push("</div>"),i.push("</div>"),this._renderButtons(i,l)},_renderTabTitles:function(i,e){var l=!0;i.push('<ul class="nav nav-tabs evol-tabs">'),_.each(e,function(e,t){"tab"===e.type&&(l?(i.push('<li class="active '+(e.cssLabel||"")+'">'),l=!1):e.cssLabel?i.push('<li class="'+e.cssLabel+'">'):i.push("<li>"),i.push('<a href="#evol-tab-'+t+'">'+e.label+"</a></li>"))}),i.push("</ul>")},_renderTab:function(i,e,l){var n=this;i.push('<div class="evol-pnls '+(e.css||"")+'">'),_.each(e.elements,function(e,t){e.id||(e.id="p-"+t),"panel-list"===e.type?n._renderPanelList(i,e,l):n._renderPanel(i,e,l)}),i.push(c.html.clearer+"</div></div>")},_renderPanel:function(t,e,i,l){var n=this,a=this.iconsPath;if("wiz"===i){var s=!_.isUndefined(l)&&!l;t.push('<div data-p-width="100" class="evol-pnl evo-p-wiz" style="width:100%;'+(s?"display:none;":"")+'">')}else t.push('<div data-p-width="'+e.width+'" class="evol-pnl" style="width:'+e.width+'%">');return t.push(c.panelBegin(e,this.style||"panel-default",!0),'<fieldset data-pid="'+e.id+(e.readonly?'" disabled>':'"><div class="evol-fset">')),_.each(e.elements,function(e){"panel-list"==e.type?n._renderPanelList(t,e,e.readonly?"browse":i):e.type==f.hidden?t.push(d.hidden(n.fieldViewId(e.id),n.getModelFieldValue(e.id,e.defaultValue,i))):(t.push('<div style="width:'+parseInt(e.width||100,10)+'%" class="evol-fld">'),"panel"===e.type?n._renderPanel(t,e,i,a):n.renderField(t,e,i,a),t.push("</div>"))}),t.push("</div></fieldset>"+c.panelEnd()+"</div>"),this},_renderPanelList:function(t,e,i){var l=!e.readonly&&"browse"!==i,n=l?i:"browse",a=v.fieldTypes;function s(e,t){t.type===a.pix?e.push('<th class="evo-col-pix">'):e.push("<th>"),e.push(t.label+(l&&t.required?c.html.required:"")+"</th>")}if(t.push('<div style="width:'+e.width+'%" class="evol-pnl" data-pid="'+e.id+'">',c.panelBegin(e,this.style,!0),'<div class="evo-plist"><table class="table" data-mid="'+(e.attribute||e.id)+'"><thead><tr>'),_.isArray(e.elements))_.each(e.elements,function(e){s(t,e)});else if(_.isObject(e.elements))for(var o in e.elements)s(t,elements[o]);return"edit"===n&&t.push("<th></th>"),t.push("</tr></thead><tbody>"),this._renderPanelListBody(t,e,null,n),t.push("</tbody></table></div>",c.panelEnd(),"</div>"),this},_renderPanelListBody:function(i,l,e,t){var n=this,a=l.elements,s=this.iconsPath||"",o="edit"===t&&!l.readonly;if(this.model){var r=this.model.get(l.attribute);if(r&&0<r.length){var d='<td class="evo-td-plusminus">'+c.buttonsPlusMinus()+"</td>";return void _.each(r,function(t,e){i.push('<tr data-idx="'+e+'">'),o?i.push(n._TDsFieldsEdit(l.elements,t)+d):_.each(a,function(e){i.push("<td>"),t[e.id]?e.type===f.bool||e.type===f.lov||e.type===f.pix?i.push(u.fieldHTML_RO(e,t[e.id],Evol.hashLov,s)):i.push(_.escape(u.fieldHTML_RO(e,t[e.id],Evol.hashLov,s))):i.push(_.escape(u.fieldHTML_RO(e,"",Evol.hashLov,s))),i.push("</td>")}),i.push("</tr>")})}}i.push(this._TRnodata(a.length||1,t))},_TRnodata:function(e,t){return'<tr data-id="nodata"><td colspan="'+("edit"===t?e+1:e)+'" class="evol-pl-nodata">'+h.nodata+("edit"===t?c.buttonsPlus():"")+"</td></tr>"},_TDsFieldsEdit:function(e,t){var i,l="",n=this.iconPath;return _.each(e,function(e){i=t[e.id],_.isUndefined(i)&&(i=""),l+="<td>"+u.fieldHTML(e,e.id,i,"edit-details",n,!0)+"</td>"}),l},renderField:function(e,t,i,l,n){var a="";return this.model&&this.model.has(t.id)&&(a="new"!==i?this.model.get(t.id):t.defaultValue||""),t.type===f.formula?(n||e.push(Evol.Dico.HTMLFieldLabel(t,i||"edit")),e.push(c.input.formula(this.fieldViewId(t.id),t,this.model))):t.type!==f.json||"browse"!==i&&!t.readOnly?e.push(u.fieldHTML(t,this.fieldViewId(t.id),a,i,l,n)):(n||e.push(Evol.Dico.HTMLFieldLabel(t,i)),e.push(c.input.textM(this.fieldViewId(t.id),Evol.Format.jsonString(a,!1),t.maxLen,t.height,!0))),this},getTitle:function(){if(this.model){if(this.model.isNew&&this.model.isNew())return h.getLabel("tools.newEntity",this.uiModel.name);var e=this.uiModel.fnTitle;return _.isFunction(e)?e(this.model):this.model.get(e)}return Evol.Format.capitalize(this.uiModel.name)},setTitle:function(e){var t=this.uiModel.fnBadge;return t&&(t=_.isString(t)?this.model.escape(t)||"":t(this.model)),u.setViewTitle(this,e,t)},validate:function(e){var a,t=e||this.getFields(),s=this.getData(!0),o=[];if(this.clearMessages(),o=this._checkFields(t,s),a=""===o,this._subCollecs){var r=this;_.each(this._subCollecs,function(e){var t=s[e.id],l=r.$('[data-pid="'+e.id+'"] tbody > tr'),n=0;if(_.each(t,function(t,i){_.each(e.elements,function(e){r.validateField(e,"date"===e.type?t[e.id]?t[e.id].substring(0,10):"":t[e.id])&&(l.eq(i).find("#"+e.id).parent().addClass("has-error"),n++)})}),0<n){var i="validation.invalidList"+(1===n?"1":"");i=h.getLabel(i,n,e.label),o.push(i),a=!1}})}return this.$el.trigger("action","validate",{valid:a}),o},valRegEx:{email:/^[\w\.\-]+@[\w\.\-]+\.[\w\.\-]+$/,integer:/^[-+]?\d+$/,decimalEN:/(\+|-)?(\d*\.\d*)?$/},_checkFields:function(e,t){var i,n=this,a=[];return _.each(e,function(e){""!==(i=n.validateField(e,t[e.id]))&&function(e,t){_.isArray(a)&&a.push(t);var i=n.$field(e.id).parent();e.type===f.email&&(i=i.parent());var l=i.find(".text-danger");l.length?l.html(t):i.append('<p class="text-danger">'+t+"</p>"),i.addClass("has-error")}(e,i)}),a},validateField:function(e,t){var i=h.validation,l=v.fieldIsNumber(e);function n(e,t,i,l){return t.replace("{0}",e).replace("{1}",i).replace("{2}",l)}function a(e){return e.label||e.labelMany}if(!e.readonly){if(e.required&&(""===t||l&&isNaN(t)||e.type===f.lov&&"0"===t||e.type===f.list&&t&&0===t.length))return n(e.label,i.empty);if(!(isNaN(t)&&l||""===t||_.isArray(t)))switch(e.type){case f.int:case f.email:if(!this.valRegEx[e.type].test(t))return n(a(e),i[e.type]);break;case f.dec:case f.money:if(!(this.valRegEx[f.dec+h.LOCALE]||this.valRegEx[f.dec+"EN"]).test(t))return n(a(e),i[e.type]);break;case f.date:case f.datetime:case f.time:if(""!==t&&!_.isDate(new Date(t)))return n(a(e),i[e.type]);break;case f.json:var s;if(_.isObject(t))s=t;else{try{s=$.parseJSON(t)}catch(e){}if(_.isUndefined(s))return n(a(e),i[e.type])}}if(null!==e.regExp&&!_.isUndefined(e.regExp)){var o=new RegExp(e.regExp);if(!t.match(o))return n(a(e),i.regExp,a(e))}if(l&&""!==t){if(e.max&&parseFloat(t)>e.max)return n(a(e),i.max,e.max);if(e.min&&parseFloat(t)<e.min)return n(a(e),i.min,e.min)}if(e.fnValidate){var r=e.fnValidate(e,t);if(""!==r)return n(a(e),r)}if(_.isString(t)){var d=t.length,c=!!e.maxLength&&d>e.maxLength,u=!!e.minLength&&d<e.minLength;if(c||u)return e.maxLength&&e.minLength?n(a(e),i.minMaxLength,e.minLength,e.maxLength):e.maxLength?n(a(e),i.maxLength,e.maxLength):n(a(e),i.minLength,e.minLength)}}return""},clearErrors:function(){return this.$(".control-group.error").removeClass("control-group error"),this.$(".has-error").removeClass("has-error"),this.$(".text-danger").remove(),this},fieldViewId:function(e){return this.prefix+"-"+e},showHelp:function(e,t,i,l){var n,a,s=_.findWhere(this.getFields(),{id:e});return s&&s.help&&(n=i.closest(".evol-fld"),"mini"===this.viewName&&(n=n.find(".evol-mini-content")),0<(a=l?[]:n.find(".help-block")).length?a.slideUp(200,function(){a.remove()}):(a=$('<span class="help-block">'+_.escape(s.help)+"</span>").hide(),n.append(a),a.slideDown(200))),this},clearMessages:function(){return this.$el.trigger("message",null),this.clearErrors()},sendMessage:function(e,t,i){return this.$el.trigger("message",{title:e,content:t,style:i})},setTab:function(e){this._showTab(e)},getTab:function(){return this._tabId},click_button:function(e){var t=$(e.currentTarget).data("id");e.stopImmediatePropagation(),"save"===t?this.validate()&&this.$el.trigger("action",t):this.$el.trigger("action",t)},click_toggle:function(e){var t=$(e.currentTarget),i=t.closest(".panel-heading").next(),l=i.data("expState"),n="glyphicon-chevron-up",a="glyphicon-chevron-down";if(e.preventDefault(),e.stopImmediatePropagation(),e.shiftKey){var s="down"===l?a:n;this.$(".evol-title-toggle."+s).trigger("click")}else"down"===l?(t.closest(".panel").css("height",""),i.slideDown(300).data("expState","up"),t.addClass(n).removeClass(a)):(i.slideUp(300,function(){t.closest(".panel").css("height","40px")}).data("expState","down"),t.removeClass(n).addClass(a));this.$el.trigger("toggle.panel")},click_tab:function(e){var t=e.currentTarget.href,i=t.substring(t.indexOf("#"));e.stopImmediatePropagation(),e.preventDefault(),e.shiftKey?this.$(".tab-content > div").show():this._showTab(i),this._tabId=i},click_help:function(e){var t="none",i=$(e.currentTarget),l=i.data("type");if(e.stopImmediatePropagation(),e.shiftKey){var n=this,a=!this._allHelp;a&&(this.$(".evol-fld>.help-block").remove(),this._allHelp=!0,t="all"),_.each(this.getFields(),function(e){if(e.help){var t=n.$field(e.id);n.showHelp(e.id,e.type,t,a)}}),this.$el.trigger(l+".help",{id:t})}else t=i.closest("label").attr("for"),this.showHelp(t,l,i),this.$el.trigger(l+".help",{id:t})},click_detailsAddDel:function(e){var t=$(e.currentTarget),i=t.data("id"),l=t.closest("tr");if(!e.keyCode||13===e.keyCode)if(e.stopImmediatePropagation(),"bPlus"===i){var n="",a=this.getSubCollecs(),s=l.closest("table").data("mid"),o=a[s]?a[s].elements:null;n+="<tr>"+this._TDsFieldsEdit(o,{})+'<td class="evo-td-plusminus">'+c.buttonsPlusMinus()+"</td></tr>",$(n).insertAfter(l),"nodata"===l.data("id")&&l.remove()}else"bMinus"===i&&(0===l.siblings().length&&$(this._TRnodata(l.children().length,"edit")).insertAfter(l),l.remove())}})}(),Evol.ViewOne.Browse=Evol.View_One.extend({viewName:"browse",editable:!1,icon:"eye-open",prefix:"ovw",getData:function(){return{}},setData:function(t){if(!_.isUndefined(t)&&null!==t){var i,l,n=this,a=Evol.DOM.input,s=Evol.Def.fieldTypes,o=Evol.Dico.fieldHTML_RO,r="#"+n.prefix+"-",e=this.getSubCollecs(),d=this.iconsPath||"";_.each(this.getFields(),function(e){if(i=n.$(r+e.id),l=e.value?e.value(t):t.get(e.attribute||e.id),t)switch(e.type){case s.lov:case s.list:case s.bool:case s.email:case s.url:case s.html:i.html(o(e,l,Evol.hashLov,d));break;case s.formula:i.html(e.formula?e.formula(t):"");break;case s.pix:i.html(l?'<img src="'+d+l+'" class="img-thumbnail">':"<p>"+Evol.i18n.nopix+"</p>");break;case s.color:i.html(a.colorBox(e.id,l,l));break;case s.textml:l?i.html(_.escape(l).replace(/[\r\n]/g,"<br>")):i.html("");break;case s.json:i.val(Evol.Format.jsonString(l,!1));break;default:i.text(o(e,l,Evol.hashLov,d)||" ")}}),e&&_.each(e,function(e){var t=[];n._renderPanelListBody(t,e,l,"browse"),n.$('[data-pid="'+e.id+'"] tbody').html(t.join(""))})}return this.setTitle()},clear:function(){var t,i=this,l=Evol.Def.fieldTypes,n="#"+i.prefix+"-",e=this.getSubCollecs();return this.clearMessages(),_.each(this.getFields(),function(e){switch(t=i.$(n+e.id),e.type){case l.bool:t.prop("checked",!!e.defaultValue&&"checked");break;case l.pix:break;default:t.html(e.defaultValue||"")}}),e&&_.each(e,function(e){i.$('[data-pid="'+e.id+'"] tbody').html(i._TRnodata(e.elements.length,"browse"))}),this},_renderButtons:function(e){e.push(Evol.DOM.html.clearer+'<div class="evol-buttons panel '+this.style+'">'+Evol.DOM.button("cancel",Evol.i18n.tools.bCancel,"btn-default")+Evol.DOM.button("edit",Evol.i18n.tools.bEdit,"btn-primary")+"</div>")}}),Evol.ViewOne.Edit=Evol.View_One.extend({viewName:"edit",icon:"edit",prefix:"oe",postRender:function(){var t="#"+this.prefix+"-",e=_.filter(this.getFields(),function(e){return"list"===e.type&&!e.readonly});_.each(e,function(e){this.$(t+e.id).select2({data:e.list,multiple:!0})})}}),Evol.ViewOne.JSON=Evol.View_One.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle"},viewName:"json",icon:"barcode",render:function(){var e=Evol.DOM;if(this.model){var t=[],i=JSON.stringify(this.model,null,2);t.push(e.panelBegin({id:"p-json",label:Evol.Format.capitalize(this.uiModel.name),label2:"JSON"},this.style+" evo-p-json",!0)+"<fieldset>"+e.label("uimjson","JSON")+e.input.textMJSON("uimjson",i,16)+"</fieldset>"+e.panelEnd()),t.push(syntaxHighlight(i)),this._renderButtons(t,"json"),this.$el.html(t.join(""))}else this.$el.html(e.HTMLMsg(Evol.i18n.nodata,"","info"));return this.setData(this.model),this},validate:function(){var e,t=this.getData(),i=this._getDOMField().parent();return e=!Evol.DOM.addRemClass(i,null===t,"has-error"),this.$el.trigger("action","validate",{valid:e}),e?[]:[Evol.i18n.validation.invalid]},getData:function(){var t,e=this._getDOMField().val();if(""===e)return e;try{t=$.parseJSON(e)}catch(e){t=null}return t},setData:function(e){return this.clearError()._getDOMField().val(JSON.stringify(e.toJSON(),null,2)),this.setTitle()},clear:function(){return this._getDOMField().val(""),this},clearError:function(){return this._getDOMField().parent().removeClass("has-error"),this},_getDOMField:function(){return this.$("textarea")}}),Evol.ViewOne.JSON=Evol.View_One.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle"},viewName:"json",icon:"barcode",render:function(){var e=Evol.DOM;if(this.model){var t=[],i=JSON.stringify(this.model,null,2);t.push(e.panelBegin({id:"p-json",label:Evol.Format.capitalize(this.uiModel.name),label2:"JSON"},this.style+" evo-p-json",!0)+"<fieldset>"+e.label("uimjson","JSON")+e.input.textMJSON("uimjson",i,16)+"</fieldset>"+e.panelEnd()),this._renderButtons(t,"json"),this.$el.html(t.join(""))}else this.$el.html(e.HTMLMsg(Evol.i18n.nodata,"","info"));return this.setData(this.model),this},validate:function(){var e,t=this.getData(),i=this._getDOMField().parent();return e=!Evol.DOM.addRemClass(i,null===t,"has-error"),this.$el.trigger("action","validate",{valid:e}),e?[]:[Evol.i18n.validation.invalid]},getData:function(){var t,e=this._getDOMField().val();if(""===e)return e;try{t=$.parseJSON(e)}catch(e){t=null}return t},setData:function(e){return this.clearError()._getDOMField().val(JSON.stringify(e.toJSON(),null,2)),this.setTitle()},clear:function(){return this._getDOMField().val(""),this},clearError:function(){return this._getDOMField().parent().removeClass("has-error"),this},_getDOMField:function(){return this.$("textarea")}}),Evol.ViewOne.Mini=function(){var s=Evol.DOM,o=Evol.Def.fieldTypes;return Evol.ViewOne.Edit.extend({events:{"click > .evol-buttons > button":"click_button","click .evol-title-toggle":"click_toggle","click label > .glyphicon-question-sign":"click_help"},viewName:"mini",icon:"th-large",prefix:"om",fieldsetFilter:function(e){return e.required||e.inMany||e.inMini},_render:function(e,t){var i={id:"p-mini",type:"panel",class:"evol-mini-holder",label:Evol.Format.capitalize(this.uiModel.name),width:100,elements:this.getFields()};this._renderPanel(e,i,t),this._renderButtons(e,t)},_renderPanel:function(t,e,i,l){var n=this,a=this.iconsPath;return t.push('<div data-p-width="100%" class="evol-pnl evol-p-mini">'+s.panelBegin(e,this.style,!0)+'<fieldset data-pid="'+e.id+(e.readonly?'" disabled>':'">')),_.each(e.elements,function(e){e.type==o.hidden?t.push(s.input.hidden(n.fieldViewId(e.id),n.getModelFieldValue(e.id,e.defaultValue,i))):(t.push('<div class="pull-left evol-fld w-100"><div class="evol-mini-label">'+Evol.Dico.HTMLFieldLabel(e,i)+'</div><div class="evol-mini-content">'),n.renderField(t,e,i,a,!0),t.push("</div></div>"))}),t.push("</fieldset>"+s.panelEnd()+"</div>"),this}})}(),Evol.ViewAction.Export=function(){var h=Evol.DOM,M=Evol.Dico,k=Evol.Def.fieldTypes,v=h.input,T=Evol.i18n,f=T.export;return Backbone.View.extend({viewName:"export",cardinality:"n",icon:"cloud-download",events:{"change .evol-xpt-format":"click_format","change input, .evol-xpt-db":"_preview","change #xpt-header":"_preview","click .evol-xpt-more":"click_toggle_sel","click button":"click_button"},options:{model:null,uiModel:null,many:!0,sampleMaxSize:20,formats:["CSV","TAB","JSON","HTML","XML","SQL"]},initialize:function(e){return _.extend(this,this.options,e),this},render:function(){return this.$el.html(this._renderHTML()),this._preview(this.formats[0]),this},_renderHTML:function(){var i,l,n,a,e="",t=this.formats,s=this.getFields(),o=h.button("export",f.DownloadEntity.replace("{0}",this.uiModel.namePlural),"btn btn-primary");e+='<div class="evol-xpt panel '+this.style+'">'+h.panelHeader({label:this.getTitle()},!1)+'<div class="evol-xpt-form clearfix"><div class="evol-xpt-flds"><div><label>'+f.xpFields+"</label></div>"+(n=14<s.length,a='<fieldset class="checkbox"><label><input type="checkbox" value="1" id="showID">'+f.IDkey+"</label>",_.each(s,function(e,t){i=e.labelExport||e.label||e.labelList,l="fx-"+e.id,null!==i&&""!==i||(i="("+l+")"),a+='<label><input type="checkbox" value="1" id="'+l+'" checked="checked">'+i+"</label>",10===t&&n&&(a+='<a href="javascript:void(0)" class="evol-xpt-more">'+f.allFields+'</a><div style="display:none;">')}),n&&(a+="</div>"),a+="</fieldset>")+'</div><div class="evol-xpt-para">';var r,d,c="evol-xpt-format",u=_.map(t,function(e){return{id:e,text:f["format"+e]}});return e+='<div class="evol-xptf"><div class="evol-xpt-format-hld"><label for="'+c+'">'+f.format+"</label>"+v.select(c,"","evol-xpt-format",!1,u)+"</div>",e+='<div class="top-btn-xpt">'+o+"</div>",e+=(r="xptFLH",d='<div class="evol-xpt-opts"><div class="evol-FLH clearfix"><label class="evol-xpt-cb1">'+v.checkbox(r,!0)+f.firstLine+"</label>"+v.select("xpt-header","","evol-xpt-header",!1,[{id:"label",text:f.headerLabels},{id:"attribute",text:f.headerIds}])+'</div><div id="xptCSV" class="evol-xpt-opt"><div data-id="csv2" class="evol-w120">'+h.fieldLabel("separator",f.separator)+v.text("separator",",","0")+"</div></div>",_.each(t,function(e){d+='<div id="xpt'+e+'" style="display:none;">&nbsp;</div>'}),(d+="</div></div>"+h.html.clearer)+'<label class="evol-xpt-pvl">'+f.preview+'</label><textarea class="evol-xpt-val form-control"></textarea></div></div></div><div class="panel '+this.style+' evol-buttons form-actions">'+h.button("cancel",T.tools.bCancel,"btn-default")+o+"</div></div>")},setModel:function(e){this.model=e},showFormatOpts:function(e){"TAB"===e?(e="CSV",this.$('[data-id="csv2"]').hide()):"CSV"===e?this.$('[data-id="csv2"]').show():this.$("#xpt"+e).html(this._formatOptions(e,this.uiModel.name));var t=this.$("#xpt"+e).show().siblings().hide();return h.showOrHide(t.filter(".evol-FLH"),"TAB"===e||"CSV"===e||"HTML"===e),this},getFields:function(){return this.fields||(this.fields=Evol.Def.getFields(this.uiModel,function(e){return e.type!=k.formula&&e.type!=k.json&&(_.isUndefined(e.inExport)||e.inExport)})),this.fields},getTitle:function(){return this.many?T.getLabel("export.exportMany",this.uiModel.namePlural):T.getLabel("export.exportOne",this.uiModel.name)},setTitle:function(){M.setViewTitle(this)},_preview:function(){this.$(".evol-xpt-val").val(this.exportContent(this.val()))},exportContent:function(e){var n="",a=e.options,s=this.sampleMaxSize-1;if(this.collection||this.model&&this.model.collection){var t=this.collection?this.collection.models:this.model.collection.models,i={};_.each(e.fields,function(e){i[e]=""});var l,o=_.filter(this.getFields(),function(e){if(e.id&&_.has(i,e.id))return!0}),r=o.length-1;switch(a.firstLineHeader&&(l="label"===a.header?function(e){var t=e.labelExport||e.label||e.id;return-1<t.indexOf(",")?'"'+t+'"':t}:function(e){return e.attribute||e.id}),e.format){case"CSV":case"TAB":case"TXT":var d=Evol.Format.trim(this.$("#separator").val());"TAB"==e.format&&(d="\t"),a.firstLineHeader&&(a.showID&&(n+="ID"+d),_.each(o,function(e,t){n+=l(e),t<r&&(n+=d)}),n+="\n"),_.every(t,function(l,e){return a.showID&&(n+=(l.id||"m"+e)+d),_.each(o,function(e,t){var i=l.get(e.id);i&&(e.type===k.bool?n+=i:(e.type==k.text||e.type==k.textml)&&-1<i.indexOf(",")?n+=i?'"'+i.replace('"','\\"')+'"':'""':e.type==k.list?n+=i?'"'+i+'"':'""':n+=i),t<r&&(n+=d)}),n+="\n",e<s}),n+="\n";break;case"HTML":n="<table>\n",a.firstLineHeader&&(n+="<tr>\n",a.showID&&(n+="<th>ID</th>"),_.each(o,function(e){n+="<th>"+l(e)+"</th>"}),n+="\n</tr>\n"),_.every(t,function(i,e){return n+="<tr>\n",a.showID&&(n+="<td>"+i.id+"</td>"),_.each(o,function(e){var t=i.get(e.id);_.isUndefined(t)||""===t?n+="<td></td>":n+="<td>"+t+"</td>"}),n+="\n</tr>\n",e<s}),n+="</table>\n";break;case"JSON":var c=_.map(o,function(e){return e.id});a.showID&&c.unshift("id"),n=[],_.every(t,function(e,t){return n.push(JSON.stringify(_.pick(e.toJSON(),c),null,2)),t<s}),n=this.many?"["+n.join(",\n")+"]":n.join("");break;case"SQL":var u,h,v,f,p,b,m,g=!1,y=a.table.replace(/ /g,"_"),w="INSERT INTO "+y+" (";switch(a.database){case"sqlserver":u=function(e){return _.isUndefined(e)||_.isObject(e)?'""':'"'+e.replace(/"/g,'""')+'"'},f="NULL",v='""',p="BEGIN TRANSACTION",b="COMMIT TRANSACTION",g=a.showID;break;default:u=function(e){return _.isUndefined(e)||_.isObject(e)?'""':"'"+e.replace(/'/g,"''")+"'"},f="null",v="''",p="BEGIN;",b="COMMIT;"}h=function(e){return _.isUndefined(e)||null===e?f:""===e?v:_.isNumber(e)?e:u(e)},a.showID&&(w+="ID, "),_.each(o,function(e,t){w+=e.id,t<r&&(w+=", ")}),w+=")\n VALUES (",a.transaction&&(n+=p+"\n"),g&&(n+="SET IDENTITY_INSERT "+y+" ON;\n"),_.every(t,function(i,e){return n+=w,a.showID&&(n+=h(i.id)+", "),_.each(o,function(e,t){switch(m=i.get(e.id),e.type){case k.int:case k.dec:case k.money:n+=m||f;break;case k.bool:n+="boolean"==typeof m?m:f;break;case k.date:case k.datetime:case k.time:_.isUndefined(m)||""===m?n+=f:n+=h(m);break;case k.list:_.isUndefined(m)||""===m||_.isArray(m)&&0===m.length?n+=f:_.isNumber(m)?n+=m:n+=h(M.fieldHTML_RO(e,m,Evol.hashLov,""));break;default:_.isUndefined(m)||""===m?n+=v:_.isNumber(m)?n+=m:n+=h(m)}t<r&&(n+=", ")}),n+=");\n",e<s}),g&&(n+="SET IDENTITY_INSERT "+y+" OFF;\n"),a.transaction&&(n+=b+"\n");break;case"XML":var x,E=a.elementName;n="<xml>\n",_.every(t,function(t,e){return n+="<"+E+" ",a.showID&&(n+='ID="'+t.id+'" '),_.each(o,function(e){n+=e.id+'="',e.type===k.text||e.type===k.textml?(x=t.get(e.id),_.isArray(x)||_.isUndefined(x)||""===x||(n+=x.replace(/"/g,'\\"'))):n+=t.get(e.id),n+='" '}),n+="></"+E+">\n",e<s}),n+="</xml>"}}else n+=T.nodata;return n},fieldHTML:function(e,t,i){return h.fieldLabel(e,t)+v.text(e,i.replace(/ /g,"_"),null,"xpt-mw300")},val:function(e){if(_.isUndefined(e)){for(var t=this.$(".evol-xpt-format").val(),i={title:this.uiModel.label||Evol.Format.capitalize(this.uiModel.entities),format:t,fields:this._valFields(),options:{}},l=this.$("#xpt"+t+" input"),n=0,a=l.length;n<a;n++){var s,o=l.eq(n);s="checkbox"===o.attr("type")?o.prop("checked"):o.val(),i.options[o.attr("id")]=s}return"CSV"===i.format||"TAB"===i.format||"HTML"===i.format?(i.options.firstLineHeader=this.$("#xptFLH").prop("checked"),i.options.firstLineHeader&&(i.options.header=this.$("#xpt-header").val()),"TAB"===i.format&&delete i.options.separator):"SQL"===i.format&&(i.options.database=this.$(".evol-xpt-db").val()||this.uiModel.table||this.uiModel.id),i.options.showID=this.$("#showID").prop("checked"),i}return this},_valFields:function(){var t=[],e=this.$(".evol-xpt-flds input:checked");return _.each(e,function(e){t.push(e.id.substr(3))}),t},_formatOptions:function(e,t){return"XML"===e?"<div>"+this.fieldHTML("elementName",f.XMLroot,t)+"</div>":"SQL"===e?'<div><label for="xpt-db">'+f.db+"</label> "+v.select("xpt-db","postgres","evol-xpt-db",null,[{id:"postgres",text:"PostgreSQL"},{id:"sqlserver",text:"SQL Server"}])+'<div class="evo-inline-holder"><div>'+this.fieldHTML("table",f.SQLTable,t)+"</div><div><label>"+v.checkbox("transaction",!1)+f.SQLTrans+"</label></div></div></div>":"&nbsp;"},click_format:function(e){var t=$(e.currentTarget).val();"XML"===t&&this.$("#XML").html(this._formatOptions("XML",this.uiModel.name)).show().siblings().not(".evol-FLH").hide(),this.showFormatOpts(t)._preview(),this.$el.trigger("change.export","format",t)},click_toggle_sel:function(e){$(e.currentTarget).hide().next().slideDown()},change_header:function(e){this._preview()},click_button:function(e){var t=$(e.currentTarget).data("id");"export"===t&&this.download(this.val()),this.$el.trigger("action",t)},download:function(e){var t=new Blob([this.$(".evol-xpt-val").val()],{type:"text/plain"}),i="TAB"===e.format?"txt":e.format.toLowerCase(),l=e.title.replace(/ /g,"_")+"."+i,n=document.createElement("a");n.download=l,n.href=window.URL.createObjectURL(t),document.body.appendChild(n),n.click(),n.remove&&n.remove()}})}(),Evol.ViewAction.Filter=function(){var l=Evol.DOM,c=l.input,v=Evol.Def.fieldTypes,f=Evol.i18n.filters,p="eq",n="ne",a="sw",s="ct",o="nct",r="fw",b="in",m="null",g="nn",d="gt",u="lt",y="bw";return Backbone.View.extend({viewName:"filter",events:{"click .evo-bNew":"click_new","click .evo-bAdd":"click_add","click .evo-bSubmit":"click_submit","click .evo-zfilters>a>button":"click_remove","click .close":"click_close"},options:{fields:[],dateFormat:"mm/dd/yyyy",buttonLabels:!1,submitButton:!1,submitReady:!1},initialize:function(e){return _.extend(this,this.options,e),this.fields.length<1&&this.uiModel&&(this.fields=_.map(Evol.Def.getFields(this.uiModel,function(e){return e.type!==v.hidden}),function(e){return e.type!==v.list?e:_.extend({},e,{type:v.lov,trueType:v.list})})),this},render:function(){var e=this.buttonLabels,n=this,t=this.$el,i="";return i+=l.html.buttonClose+'<div class="evo-zfilters"></div><a class="evo-bNew btn btn-primary btn-group-sm glyphicon glyphicon-plus" href="javascript:void(0)"></a>',this.submitButton&&(i+='<a class="evo-bSubmit btn btn-primary glyphicon glyphicon-ok" href="javascript:void(0)"></a>'),i+='<div class="evo-editFilter"></div><a class="evo-bAdd btn btn-primary glyphicon glyphicon-ok" style="display:none;" href="javascript:void(0)"></a><a class="evo-bDel btn btn-default glyphicon glyphicon-remove" style="display:none;" href="javascript:void(0)"></a>',t.html(i),this._step=0,this.submitReady&&(this._hValues=$("<span></span>").appendTo(t)),this.submitButton&&(this._bSubmit=t.find(".evo-bSubmit").button({text:e})),this._bNew=t.find(".evo-bNew").button({text:e,icons:{secondary:"ui-icon-plusthick"}}),this._bAdd=t.find(".evo-bAdd").button({text:e,icons:{secondary:"ui-icon-check"}}),this._bDel=t.find(".evo-bDel").button({text:e,icons:{secondary:"ui-icon-close"}}).on("click",function(e){n._removeEditor()}),this._editor=t.find(".evo-editFilter").on("change","#field",function(e){e.stopPropagation(),2<n._step&&n._editor.find("#value,#value2,.as-Txt").remove(),1<n._step&&(n._editor.find("#operator").remove(),n._bAdd.hide()),n._step=1;var t=$(e.currentTarget).val();if(""!==t){n._field=n._getFieldById(t);var i=n._type=n._field.type;n._setEditorOperator(),i!==v.lov&&i!==v.bool||n._setEditorValue()}else n._field=n._type=null}).on("change","#operator",function(e){e.stopPropagation(),n._operator=$(this).val(),2<n._step&&(n._editor.find("#value,#value2,.as-Txt").remove(),n._bAdd.hide(),n._step=2),n._setEditorValue()}).on("change keyup","#value,#value2",function(e){e.stopPropagation();var t=n._type,i=$(this).val(),l=""!==i||t===v.lov||t===v.bool;"number"==t?l=l&&!isNaN(i):n._operator==y&&(l=""!==n._editor.find("#value").val()&&""!==n._editor.find("#value2").val()),l?(n._bAdd.button("enable"),13===e.which&&n._bAdd.trigger("click")):n._bAdd.button("disable")}).on("click","#checkAll",function(){var e=$(this);l.toggleCheckbox(e.siblings(),e.prop("checked"))}),this._filters=t.find(".evo-zfilters").on("click","a",function(){n._editCond($(this))}).on("click","a>button",function(e){e.stopPropagation();var t=$(this).parent();t.hasClass("ui-state-disabled")||(t.fadeOut("slow",function(){t.remove(),n._triggerChange()}),n._removeEditor())}),this},_getFieldById:function(e){return this._hash||(this._hash=Evol.Def.getFieldsHash(this.fields)),this._hash[e]},_removeEditor:function(){this._editor.empty(),this._bAdd.hide(),this._bDel.hide(),this._enableCond(null,!1),this._bNew.removeClass("ui-state-active").show().focus(),this._bSubmit&&this._bSubmit.removeClass("ui-state-active").show(),this._step=0,this._field=this._type=this._operator=null},addCondition:function(e){$('<a href="javascript:void(0)">'+this._htmlCond(e)+"</a>").prependTo(this._filters).data("filter",e).fadeIn();return this._triggerChange(),this},removeCondition:function(e){return this._filters.children().eq(e).remove(),this._triggerChange(),this},_htmlCond:function(e){var t='<span class="evo-lBold">'+e.field.label+'</span> <span class="evo-lLight">'+e.operator.label+'</span> <span class="evo-lBold">'+e.value.label+"</span>";return e.operator.value==y&&(t+='<span class="evo-lLight"> '+f.opAnd+' </span><span class="evo-lBold">'+e.value.label2+"</span>"),t+=l.html.buttonClose},_enableCond:function(e,t){this._cFilter&&(this._cFilter.removeClass("disabled"),e?(this._cFilter.data("filter",e).html(this._htmlCond(e)),this._cFilter=null,this._triggerChange()):this._cFilter=null)},_editCond:function(e){var t=e.data("filter"),i=t.field.value,l=t.operator.value,n=t.value;this._enableCond(null,!1),this._removeEditor(),this._cFilter=e.addClass("disabled"),this._setEditorField(i),this._setEditorOperator(l),l==y?this._setEditorValue(n.value,n.value2):this._setEditorValue(n.value),this._bAdd.find(".ui-button-text").html(f.bUpdateFilter),this._step=3},_setEditorField:function(e){if(this._step<1){if(this._bNew.stop().hide(),this._bSubmit&&this._bSubmit.stop().hide(),this._bDel.show(),!this._fList){for(var t,i=this.fields,l='<select id="field" class="form-control"><option value=""></option>',n=0,a=i.length;n<a;n++)t=i[n],l+=c.option(t.id,t.label||t.labelList||"("+t.id+")");l+="</select>",this._fList=l}$(this._fList).appendTo(this._editor).focus()}e&&(this._field=this._getFieldById(e),this._type=this._field.type,this._editor.find("#field").val(e)),this._step=1},_setEditorOperator:function(e){var t=c.option,i=this._type;if(this._step<2){var l="";switch(i){case v.lov:l+=c.hidden("operator",b),this._operator=b;break;case v.bool:l+=c.hidden("operator",p),this._operator=p;break;default:switch(l+=c.selectBegin("operator","",!0),i){case v.date:case v.datetime:case v.time:i==v.time?l+=t(p,f.sAt)+t(n,f.sNotAt):l+=t(p,f.sOn)+t(n,f.sNotOn),l+=t(d,f.sAfter)+t(u,f.sBefore);break;case v.int:case v.dec:case v.money:l+=t(p,f.sNumEqual)+t(n,f.sNumNotEqual)+t(d,f.sGreater)+t(u,f.sSmaller);break;default:l+=t(a,f.sStart)+t(p,f.sEqual)+t(n,f.sNotEqual)+t(s,f.sContain)+t(o,f.sNotContain)+t(r,f.sFinish)}l+=t(m,f.sIsNull)+t(g,f.sIsNotNull)+"</select>"}this._editor.append(l)}e&&i!=v.lov&&(this._editor.find("#operator").val(e),this._operator=e),this._step=2},_setEditorValue:function(e,t){var i=this._editor,l=this._type,n=i.find("#operator").val(),a=!1,s=!0;if(""!==n){if(l==v.lov||n!=m&&n!=g){if(this._step<3){var o="";switch(a=n==y,l){case v.lov:o+='<section id="value">'+(7<this._field.list.length?'(<input type="checkbox" id="checkAll" value="1"><label for="checkAll">All</label>) ':"")+c.checkboxLOV(this._field.list)+"</section>";break;case v.bool:o+='<span id="value">'+c.radio("value","1",f.yes,"0"!=e,"value1")+c.radio("value","0",f.no,"0"==e,"value0")+"</span>";break;case v.date:case v.datetime:case v.time:case v.int:case v.dec:case v.money:var r=l==v.date?"text":l;o+='<input id="value" type="'+r+'" class="form-control">',a&&(o+='<span class="as-Txt">'+f.opAnd+' </span><input id="value2" type="'+r+'" class="form-control">'),s=!1;break;default:o+='<input id="value" type="text" class="form-control">',s=!1}i.append(o),l==v.date&&i.find("#value,#value2").datepicker({dateFormat:this.dateFormat})}if(e){var d=i.find("#value");switch(l){case v.lov:d.find("#"+e.split(",").join(",#")).prop("checked","checked");break;case v.bool:d.find("#value"+e).prop("checked","checked");break;default:d.val(e),s=""!==e,a&&(d.next().next().val(t),s=""!==e&&""!==t)}}else s=l==v.lov||l==v.bool}else i.append(c.hidden("value",""));this._bAdd.button(s?"enable":"disable").show(),this._step=3}},_getEditorData:function(){function e(e){var t=h.split("/");return 2<t.length?t[2]+"-"+t[0]+"-"+t[1]:e}var t=this._editor,i=t.find("#field"),l=t.find("#value"),n={field:{label:i.find("option:selected").text(),value:i.val()},operator:{},value:{}},a=n.operator,s=n.value;if(this._type==v.lov){var o=[],r=[];l.find("input:checked").not("#checkAll").each(function(){o.push(this.value),r.push(this.nextSibling.innerHTML)}),0===o.length?(a.label=f.sIsNull,a.value=m,s.label=s.value=""):1==o.length?(a.label=f.sEqual,a.value=p,s.label='"'+r[0]+'"',s.value=o[0]):(a.label=f.sInList,a.value=b,s.label="("+r.join(", ")+")",s.value=o.join(","))}else if(this._type==v.bool){a.label=f.sEqual,a.value=p;var d=l.find("#value1").prop("checked")?1:0;s.label=1==d?f.yes:f.no,s.value=d}else{var c=t.find("#operator"),u=c.val();if(a.label=c.find("option:selected").text(),(a.value=u)==m||u==g)s.label=s.value="";else{var h=l.val();switch(s.label=h,this._type){case v.text:s.value=h.toLocaleLowerCase();break;case v.date:case v.datetime:s.value=e(h);break;case v.int:s.value=h&&"string"==typeof h?parseInt(h):null;break;case v.dec:s.value=h&&"string"==typeof h?parseFloat(h):null;break;default:s.value=h}u==y&&(h=l.next().next().val(),s.label2=h,this._type===v.date||this._type===v.datetime?(s.value2=e(h),s.label2=h):s.value2=h)}}return n},_hiddenValue:function(e,t){var i=c.hidden,l=e.value.value2,n=i("fld-"+t,e.field.value)+i("op-"+t,e.operator.value)+i("val-"+t,e.value.value);return l&&(n+=i("val2-"+t,l)),n},_setHiddenValues:function(){for(var e=this.val(),t=e.length,i=c.hidden("elem",t),l=0;l<t;l++)i+=this._hiddenValue(e[l],l+1);this._hValues.html(i)},_triggerChange:function(){this.submitReady&&this._setHiddenValues(),this.$el.trigger("change.filter")},val:function(e){if(_.isUndefined(e)){var t=[];return this._filters.find("a").each(function(){t.push($(this).data("filter"))}),t}this._filters.empty();for(var i=0,l=e.length;i<l;i++)this.addCondition(e[i]);return this._triggerChange(),this},valText:function(){var e=[];return this._filters.find("a").each(function(){e.push(this.text)}),e.join(" "+f.opAnd+" ")},clear:function(){return this._cFilter=null,this._removeEditor(),this._filters.empty(),this._triggerChange(),this},length:function(){return this._filters.children().length},click_new:function(e){this._step<1&&(this._setEditorField(),this._step=1),this._bAdd.find(".ui-button-text").html(f.bAddCond)},click_add:function(e){var t=this._getEditorData();this._cFilter?this._enableCond(t,this.highlight):this.addCondition(t),this._removeEditor()},click_remove:function(e){e.stopImmediatePropagation(),e.stopPropagation(),$(e.currentTarget).closest("a").remove(),this._triggerChange()},click_submit:function(e){this.$el.trigger("submit.filter")},click_close:function(e){this.$el.trigger("close.filter"),this.clear()}})}(),Evol.ViewAction.Import=function(){var e=Evol.DOM,t=Evol.Dico,i=(Evol.Def.fieldTypes,e.input,Evol.i18n),l=i.export,n=i.import;return Backbone.View.extend({viewName:"import",cardinality:"n",icon:"cloud-upload",events:{"click button":"click_button","change #iptFormat":"change_format","click .ipt-ssample":"toggle_sample"},options:{noDups:!1},initialize:function(e){return _.extend(this,this.options,e),this},render:function(){return this.format="csv",this.$el.html(this._renderHTML()),this},_renderHTML:function(){return e.panelBegin({id:"",type:"panel",label:this.getTitle(),width:100},"evol-xpt "+this.style,!1)+'<div class="evol-fset"><div class="evol-fld w-100"><label class="lbl-block">'+n.format+"</label>"+e.input.lov("iptFormat","value","",[{id:"csv",text:l.formatCSV},{id:"json",text:l.formatJSON}])+'<a href="javascript:void(0);" class="ipt-ssample">CSV '+n.fSample+"</a>"+e.html.clearer+'</div><div class="evol-ipt-fh"><textarea class="evol-ipt-format help-block" style="resize:none;"></textarea></div><div class="evol-fld w-100"><label style="margin-top:10px;">'+n.data+'</label><textarea class="evol-xpt-val form-control" id="import_data" rows="12"></textarea></div></div>'+e.panelEnd()+'<div class="panel '+this.style+' evol-buttons form-actions">'+e.button("cancel",i.tools.bCancel,"btn-default")+e.button("import",n.importMany.replace("{0}",this.uiModel.namePlural),"btn btn-primary")+"</div>"},importData:function(e,i,t){var l,n=t&&t.noDuplicates;if(i){if(Evol.Config.localStorage){var a=new Backbone.LocalStorage("evol-"+e);l=Backbone.Model.extend({localStorage:a}),Ms=Backbone.Collection.extend({model:l,localStorage:a})}else l=new Backbone.Model({urlRoot:Evol.Config.url+e}),Ms=Backbone.Collection.extend({model:l,url:Evol.Config.url+e});var s=new Ms,o=0,r=0;return s.fetch({success:function(t){_.each(i,function(e){n||delete e.id,t.create(e,{success:function(e){o++},error:function(e){r++}})})},error:function(e,t){alert("Error"+e+t)}}),{total:i.length,inserts:o,errors:r}}return{total:0,inserts:0,errors:0}},setModel:function(e){this.model=e},getTitle:function(){return i.getLabel("import.importMany",this.uiModel.namePlural)},setTitle:function(){t.setViewTitle(this)},val:function(e){return this.$("#import_data").val()},click_button:function(e){var t=$(e.currentTarget).data("id");if("import"===t){var i;if("csv"===this.format){var l=(i=Papa.parse(this.val())).data[0],n=[];_.forEach(i.data,function(e,t){var i={};0<t&&(_.forEach(e,function(e,t){i[l[t]]=e}),n.push(i))}),i=n}else{try{i=JSON.parse(this.val())}catch(e){alert("Invalid JSON.")}_.isArray(i)||(i=[i])}i&&this.$el.trigger("action",{id:t,data:this.importData(this.uiModel.id,i)})}},change_format:function(e){var t=$(e.currentTarget).val();this.format=t,this.$(".evol-ipt-format").val(this.makeSample(t)),this.$(".ipt-ssample").html(t.toUpperCase()+" "+n.fSample),this.sampled=!0},makeSample:function(e){var l=this.getFields();function t(t){var i={};return _.forEach(l,function(e){i[e.attribute]=Evol.Def.sampleDatum(e,t)}),i}var i=[t(0),t(1)],n="";if("json"===e)n=JSON.stringify(i,null,"\t");else{var a=[];for(var s in i[0])a.push(s);n+=a.join(","),_.each(i,function(t){var i=[];_.each(a,function(e){i.push(t[e])}),n+="\n"+i.join(",")})}return n},toggle_sample:function(e){$(e.currentTarget);var t=this.$(".evol-ipt-fh");this.sampleShown?t.css("height",0):(this.sampled||this.$(".evol-ipt-format").val(this.makeSample("csv")),this.sampled=!0,t.css("height","180px")),this.sampleShown=!this.sampleShown},getFields:function(){return this._fields||(this._fields=Evol.Def.getFields(this.uiModel)),this._fields}})}(),Evol.viewClasses={getClass:function(e){return this[e]?this[e]:this.list}},_.forEach(["browse","edit","mini","json"],function(e){Evol.viewClasses[e]=Evol.ViewOne["json"===e?"JSON":Evol.Format.capitalize(e)]}),_.forEach(["list","cards","bubbles","charts"],function(e){Evol.viewClasses[e]=Evol.ViewMany[Evol.Format.capitalize(e)]}),_.forEach(["filter","export","import"],function(e){Evol.viewClasses[e]=Evol.ViewAction[Evol.Format.capitalize(e)]}),toastr&&(toastr.options={hideDuration:0,closeButton:!0,progressBar:!0}),Evol.Toolbar=function(){var u=Evol.DOM,h=Evol.i18n,s=h.tools;return Backbone.View.extend({events:{"click .nav a":"click_toolbar","navigate.many >div":"click_navigate","paginate.many >div":"paginate","click .evo-search>.btn":"click_search","keyup .evo-search>input":"key_search","click .evo-search>.clear-icon":"clear_search","change.tab >div":"change_tab","action >div":"click_action","status >div":"status_update","change.filter >div":"change_filter","close.filter >div":"hideFilter","click .alert-dismissable>button":"clearMessage","message >div":"showMessage"},options:{toolbar:!0,readonly:!1,defaultView:"list",defaultViewOne:"browse",defaultViewMany:"list",style:"panel-info",display:"label",titleSelector:"#title",pageSize:20,buttons:{always:[{id:"list",label:s.bList,icon:"th-list",n:"x"},{id:"charts",label:s.bCharts,icon:"stats",n:"x"},{id:"new",label:s.bNew,icon:"plus",n:"x",readonly:!1}],actions:[{id:"edit",label:s.bEdit,icon:"edit",n:"1",readonly:!1},{id:"save",label:s.bSave,icon:"floppy-disk",n:"1",readonly:!1},{id:"del",label:s.bDelete,icon:"trash",n:"1",readonly:!1},{id:"filter",label:s.bFilter,icon:"filter",n:"n"},{id:"export",label:s.bExport,icon:"cloud-download",n:"n"}],moreActions:[],prevNext:[{id:"prev",label:s.prev,icon:"chevron-left",n:"x"},{id:"next",label:s.next,icon:"chevron-right",n:"x"}],views:[{id:"browse",label:s.bBrowse,icon:"eye-open",n:"1"},{id:"edit",label:s.bEdit,icon:"edit",n:"1",readonly:!1},{id:"mini",label:s.bMini,icon:"th-large",n:"1",readonly:!1},{id:"json",label:s.bJSON,icon:"barcode",n:"1",readonly:!1},{id:"list",label:s.bList,icon:"th-list",n:"n"},{id:"cards",label:s.bCards,icon:"th-large",n:"n"},{id:"bubbles",label:s.bBubbles,icon:"adjust",n:"n"}],search:!0}},initialize:function(e){_.extend(this,this.options,e),this.views=[],this.viewsHash={}},render:function(){return this.$el.html(this._toolbarHTML()),this.setView(this.defaultViewMany,!1),this.$(".dropdown-toggle").dropdown(),this},_toolbarHTML:function(){var t,i=!1!==this.readonly,l=this.uiModel.name||"item",n=u.menu,e=this.buttons,a='<li class="divider" data-cardi="x"></li>',s='<li class="divider-h"></li>';function o(e,t){return n.hItem(e.id,t?"":"New"==e.label?"New "+l:e.label,e.icon,e.n)}function r(e,t){return _.map(e,function(e){return i&&!1===e.readonly?null:o(e,t)}).join("")}return t='<div class="evo-toolbar"><ul class="nav nav-pills pull-left" data-id="main">'+r(e.always)+s,t+=r(e.actions),e.moreActions&&e.moreActions.length&&(t+=n.hBegin("more","li","menu-hamburger","","n"),_.each(e.moreActions,function(e){"-"===e.id?t+=a:t+=o(e)}),t+=n.hEnd("li")),e.search&&(t+=a,t+='<li><div class="input-group evo-search"><input class="evo-field form-control" type="text" maxlength="100" required><div class="clear-icon glyphicon glyphicon-remove"></div><span class="btn input-group-addon glyphicon glyphicon-search"></span></div></li>'),this.toolbar&&(t+='</ul><ul class="nav nav-pills pull-right" data-id="views">',t+='<li class="evo-tb-status" data-cardi="n"></li>',t+=r(e.prevNext),t+=s+r(e.views,!1)),t+="</ul>"+u.html.clearer+"</div>"},refresh:function(){return this.curView&&this.curView.cardinality&&"n"===this.curView.cardinality&&this.curView.render(),this},clearViews:function(e){$("[data-vid=evolw-*]").remove()},isDirty:function(){return!!(this.curView&&this.curView.isDirty&&this.curView.isDirty())},_setView:function(e,t,i){var l,n=this.$el,a="evolw-"+e,s=this.$('[data-vid="'+a+'"]'),o=this.curView,r=this._curCollec();if("new"===e)e=this._prevViewOne&&"browse"!=this._prevViewOne&&"json"!=this._prevViewOne?this._prevViewOne:"edit",this.setView(e,!1,!0),this.model=new this.modelClass,this.model.collection=r,o.model=this.model,this.newItem(),this.setIcons("new"),o.mode="new",this.hideFilter();else{var d=Evol.viewClasses.getClass(e);if(s.length)this.model=o.model,o.model&&(this.model.collection=r),(o=this.viewsHash[e])&&o.setCollection&&o.setCollection(r),this.model&&!this.model.isNew()?(o.setModel?(o.collection||(o.collection=this.model.collection),o.setModel(this.model)):o.model=this.model,o.setTitle&&o.setTitle(),this._tabId&&o.getTab&&this._tabId!=o.getTab()&&o.setTab(this._tabId),"n"===o.cardinality&&o.setPage&&this.pageIndex&&o.setPage(this.pageIndex)):o.clear&&o.clear(),this.$('[data-id="views"] > li').removeClass("evo-sel").filter('[data-id="'+e+'"]').addClass("evo-sel"),this.curView=o,this._keepTab(e),s.show().siblings().not(".evo-toolbar,.evo-filters,.clearfix").hide();else{if(s=$('<div data-vid="evolw-'+e+'"></div>'),n.children().not(".evo-toolbar,.evo-filters,.clearfix").hide(),n.append(s),l={el:s,mode:e,model:this.model,collection:r,uiModel:this.uiModel,style:this.style,pageSize:this.pageSize||20,pageIndex:this.pageIndex||0,titleSelector:this.titleSelector,router:this.router},this.$('[data-id="new"]').show(),this.$('[data-id="views"] > li').removeClass("evo-sel").filter('[data-id="'+e+'"]').addClass("evo-sel"),Evol.Def.isViewMany(e))o=new d(l).render(),this._prevViewMany=e,o.setTitle(),"charts"!=e&&"bubbles"!=e&&0<this.pageIndex&&o.setPage(this.pageIndex||0);else switch(e){case"export":l.sampleMaxSize=l.pageSize,o=new d(l).render();break;case"import":o=new d(l={el:s,mode:e,uiModel:this.uiModel,collection:this.collection,style:this.style,titleSelector:this.titleSelector,router:this.router}).render();break;default:o&&o.editable&&o.getData(),o=new d(l).render(),this._prevViewOne=e,this._keepTab(e)}_.isUndefined(o)?alert("error: invalid route (for toolbar)."):(this.curView=o,this.viewsHash[e]=o,i||this.setTitle())}}this.updateStatus(),"n"===o.cardinality?(this.setRoute("",!1),!this._filterOn&&this._filterValue&&this.showFilter(!1),this.updateNav()):(this.hideFilter(),t&&this.setRoute(this.model?this.model.id:null,!1),this.hideFilter(),this._enableNav()),i||this.setIcons(e)},setView:function(e,t,i){var l=this;return this.proceedIfReady(function(){l._setView(e,t,i)}),this},getView:function(){return this.curView},proceedIfReady:function(e,t){var i,l,n=this,a=a;return this.isDirty()?(i=a.unSavedChanges.replace("{0}",this.curView.getTitle())+"<br><br>"+a.warnNoSave,l={nosave:e,ok:function(){0===n.curView.validate().length&&(n.saveItem(!1,!0),e())}},t&&(l.cancel=t),u.modal.confirm("isDirty",a.unSavedTitle,i,l,[{id:"nosave",text:s.bNoSave,class:"btn-default"},{id:"cancel",text:s.bCancel,class:"btn-default"},{id:"ok",text:s.bSave,class:"btn-primary"}])):e(),this},_keepTab:function(e){!this.tabId||"browse"!=e&&"edit"!=e||this.curView.setTab(this.tabId)},getToolbarButtons:function(){if(!this._toolbarButtons){var e=this.$(".evo-toolbar"),t=e.find(">ul>li"),i=e.find('[data-id="views"]');this._toolbarButtons={ones:t.filter('li[data-cardi="1"]'),manys:t.filter('li[data-cardi="n"]'),edit:t.filter('[data-id="main"]>[data-id="edit"]'),del:t.filter('[data-id="del"]'),save:t.filter('[data-id="save"]'),prevNext:t.filter('[data-id="prev"],[data-id="next"]'),more:t.filter('[data-id="more"]'),views:i,viewsIcon:this.$(".glyphicon-eye-open,.glyphicon-eye-close"),vws:i.find("ul>li>a")}}return this._toolbarButtons},setIcons:function(e){var l=u.showOrHide,t="export"===e||"import"===e;function i(e,t,i){l(n.ones,t),l(n.manys,i),n.vws.removeAttr("style"),n.views.find('[data-id="'+e+'"]>a').css("color","#428bca")}if(this.$el){var n=this.getToolbarButtons();if(n.prevNext.hide(),l(n.views,!(t||"new"==e)),n.del.hide(),Evol.Def.isViewMany(e)){if(i(this._prevViewMany=e,!1,!0),"charts"!==e&&"bubbles"!==e){var a=this.collection.length;this.curView.pageSize<a&&n.prevNext.show()}}else this.model&&this.model.isNew()||"new"===e||t?(i(e,!1,!1),n.del.hide(),n.views.hide(),l(n.more,t),l(n.save,!t)):(i(this._prevViewOne=e,!0,!1),n.prevNext.show(),l(n.save,"browse"!==e),l(n.edit,"browse"===e))}},showFilter:function(e){if(this._filters)this._filters.$el.show();else if(e){var t=this,i=$(u.panelEmpty("filters","evo-filters","info"));this.$(".evo-toolbar").after(i),this._filters=new Evol.ViewAction.Filter({el:i,uiModel:this.uiModel}).render(),i.on("change.filter",function(){t.curView.setFilter(t._filters.val()),"bubbles"!==t.curView.viewName&&t.curView.render()})}return this._filterOn=!0,this},hideFilter:function(){return this._filters&&this._filters.$el.hide(),this._filterOn=!1,this},toggleFilter:function(e){return this._filterOn=_.isBoolean(e)?e:!this._filterOn,this._filterOn?this.showFilter(!0):this.hideFilter()},_flagFilterIcon:function(e){u.addRemClass(this.$('a[data-id="filter"]'),e,"evo-filter-on")},setData:function(e){return this.curView&&this.curView.setData(e),this},getData:function(e){return this.curView?this.curView.getData(e):null},getCollection:function(){return this._curCollec()},setModelById:function(e,t){function i(){a.model=n,t||("1"!=a.curView.cardinality&&a.setView(a.defaultViewOne),a.curView.setModel(n),u.scroll2Top())}function l(){alert("Error: Invalid model ID.")}var n,a=this;if(Evol.Config.localStorage)n=this.collection.get(e),_.isUndefined(n)?l():i();else{var s=Backbone.Model.extend({urlRoot:Evol.Config.url+a.uiModel.id});(n=new s({id:e})).fetch({success:i,error:l})}return this},navPrevNext:function(e){var t=this._curCollec(),i=this.curView.model;if(i&&t&&t.length){var l=t.length-1,n=_.indexOf(t.models,i);n="prev"===e?0<n?n-1:l:n<l?n+1:0,i=t.models[n]}else i=null;return this.model=i,this.curView.setModel(i),i?this.setRoute(i?i.id:null,!1):this.setMessage(h.notFound,h.getLabel("notFoundMsg",this.uiModel.name),"error"),this.clearMessage()},setRoute:function(e,t,i){return Evol.Dico.setRoute(this.router,this.uiModel.id,i||this.curView.viewName,e,t),Evol.Dico.setPageTitle(this.curView.getTitle()),this},saveItem:function(t,e){var i=this,l=this.curView,n=e?[]:l.validate();function a(e){t?(i.newItem(),this._trigger("item.added")):(e.unset(""),i.model=e,i._filteredCollection&&i._filteredCollection.add(e),i.setIcons("edit"),l.setModel(e),i._trigger("item.saved",{model:e,uiModel:i.uiModel})),l.setTitle()}if(0===n.length){var s=this.uiModel.name;if(_.isUndefined(this.model)||this.model&&this.model.isNew())this.collection?(this.collection.create(this.getData(!0),{success:function(e){a(e),i.setRoute(e.id,!1),i.setMessage(h.getLabel("saved",Evol.Format.capitalize(s)),h.getLabel("msg.added",s,_.escape(l.getTitle())),"success")},error:function(e,t){alert('Error in "saveItem"')}}),this.mode="edit"):alert("Can't save record b/c no collection is specified.");else{var o=this.getData(!0);this.model.set(o),this.model.save(this.model.changedAttributes(),{success:function(e){a(e),i.collection.set(e,{remove:!1}),i.setMessage(h.getLabel("saved",Evol.Format.capitalize(s)),h.getLabel("msg.updated",Evol.Format.capitalize(s),_.escape(l.getTitle())),"success")},error:function(e,t){alert("Error "+t.status+" - "+t.statusText)}})}}else{var r="<ul><li>"+n.join("</li><li>")+"</li></ul>";this.setMessage(h.validation.incomplete,r,"warning")}return this},newItem:function(){var e=this.curView;return"browse"===e.viewName&&("browse"!==this._prevViewOne&&"json"!==this._prevViewOne?this.setView(this._prevViewOne):this.setView("edit",!1,!0)),this.curView.setDefaults().setTitle(h.getLabel("tools.newEntity",this.uiModel.name,e.getTitle()))},deleteItem:function(e,a,s){var t,o=this,r=(a||this.uiModel.id,this.uiModel.name),d=s&&s.title||this.curView.getTitle();if(a||"1"===this.curView.cardinality){if(a){var i=Evol.Config.localStorage?""+a:a;this.model=this.collection.findWhere({id:i});var l=this.uiModel.fnTitle;l&&this.model&&(d=_.isString(l)?this.model.get(l):l(o.model))}t=function(){var t=o.collection,e=_.indexOf(t.models,c),i=e,l=null;1<t.length&&(i=0===e?1:e<t.length-1?e+1:e-1,l=t.at(i)),l&&(l.collection=t);var n={success:function(){null===l||0===t.length?o.curView.clear&&o.curView.clear():(o.model=l,a||(o.setRoute(l.id,!1),o.curView.setModel(l)));var e=Evol.Format.capitalize(r);o.setMessage(h.getLabel("deleted1",e),h.getLabel("msg.deleted",e,d),"info"),s&&s.fnSuccess&&s.fnSuccess(),o._trigger("item.deleted")},error:function(e,t){alert('error in "deleteItem"')}};a||Evol.Config.localStorage||(n.url=o.model.url()),t.remove(c),c.destroy(n)};var c=this.model;c&&(e?t():u.modal.confirm("delete",h.getLabel("deleteX",r),h.getLabel("delete1",r,_.escape(d)),{ok:t}))}},setMessage:function(e,t,i){return toastr[i||"info"](t,e),this},clearMessage:function(){return this.$('[data-id="msg"]').remove(),toastr.clear(),this},showMessage:function(e,t){return t?this.setMessage(t.title,t.content,t.style):this.clearMessage()},setTitle:function(){return this.curView&&this.curView.setTitle(),this},getStatus:function(){return"n"===this.curView.cardinality?this._filteredCollection?this._filteredCollection.length+" / "+this.collection.length+" "+this.uiModel.namePlural:this.collection.length+" "+this.uiModel.namePlural:""},setStatus:function(e){this.$(".evo-toolbar .evo-tb-status").html(e),this.$(".evo-many-summary").html(e)},updateStatus:function(){this.setStatus(this.getStatus())},click_action:function(e,t){var i;switch(i=_.isString(t)?t:t.id){case"cancel":window.history.back();break;case"edit":t.mid?(this.setModelById(t.mid),this.setRoute(t.mid,!1,"edit")):this.setView(i,!0);break;case"delete":t.mid&&this.deleteItem(t.skipWarning,t.mid,t);break;case"save":case"save-add":this.saveItem("save-add"===i);break;case"import":var l,n,a=t.data;a&&a.total?(n=a.errors.length?a.inserts.length?"warning":"error":"success",l=a.inserts+" "+this.uiModel.name+" added.",0<a.errors&&(l+="<br>"+a.errors.length+" Errors."),this.setMessage(h.import.success,l,n)):this.setMessage(h.import.empty,"","warning")}},paginate:function(e,t){t&&(e=t.id);var i=this.pageIndex||0;if("prev"===e)i=0<i?i-1:0;else if("next"===e)(i+1)*this.pageSize<this.curView.collection.length&&i++;else{var l=parseInt(e,10);0<l&&(i=l-1)}return this.pageIndex=i,this.updateNav(),this.curView.setPage&&this.curView.setPage(i),this},updateNav:function(){var e=this.curView.collection?this.curView.collection.length:0,t="disabled",i=this.pageIndex||0,l=this.$('[data-id="prev"]');u.addRemClass(l,0===i,t),u.addRemClass(l.next(),(i+1)*this.pageSize>e,t)},_enableNav:function(){this.$('[data-id="prev"],[data-id="next"]').removeClass("disabled")},status_update:function(e,t){this.setStatus(t)},_curCollec:function(){return this._filteredCollection?this._filteredCollection:this.collection?this.collection:this.model?this.model.collection:new this.collectionClass},click_toolbar:function(e,t){var i=$(e.currentTarget);"A"!==i.tagName&&(i=i.closest("a"));var l=i.data("id");switch(l){case"save":this.saveItem(!1);break;case"del":this.deleteItem(e.shiftKey);break;case"filter":this.toggleFilter();break;case"prev":case"next":if("1"===this.curView.cardinality){var n=this;this.proceedIfReady(function(){n.navPrevNext(l)})}else"n"===this.curView.cardinality&&this.paginate(l);break;default:l&&""!==l&&this.setView(l,!0),this.updateStatus()}this._trigger("toolbar."+l)},_trigger:function(e,t){this.$el.trigger(e,t)},click_navigate:function(e,t,i){e.stopImmediatePropagation(),this.setModelById(t.id),t.view&&this.setView(t.view),this.setRoute(t.id,!1,t.view)},change_tab:function(e,t){t&&(this._tabId=t.id)},change_filter:function(e){if("filter"===e.namespace){var t,i=this._filters.val();if(i.length){var l=this._searchString?this._filteredCollection.models:this.model.collection.models;l=Evol.Dico.filterModels(l,i),t=this.collectionClass?new this.collectionClass(l):new Backbone.Collection(l),this._filteredCollection=t,this._filterValue=i}else t=this.collection,this._filteredCollection=null,this._filterValue=null;this.updateStatus(),this._flagFilterIcon(i.length),this.pageIndex=0,this.curView.setCollection(t),this.updateNav(),this._trigger("filter.change")}},click_search:function(e){var t,i=this.$(".evo-search>input").val().toLowerCase(),l=Evol.Def.fnSearch(this.uiModel,i);if(this._searchString=i){var n=(this.collection||this.model.collection).models.filter(l);t=this.collectionClass?new this.collectionClass(n):new Backbone.Collection(n),this._filteredCollection=t}else t=this.collection,this._filteredCollection=null;this.updateStatus(),this.pageIndex=0,"many"===this.curView.viewType||this.curView.isChart||this.setView("list",!0),this.curView.setCollection(t),this.updateNav(),this._trigger("search")},key_search:function(e){13===e.keyCode&&(e.preventDefault(),this.click_search(e))},clear_search:function(e){var t=this.collection;this._filteredCollection=null,this.updateStatus(),this.pageIndex=0,this.curView.setCollection&&this.curView.setCollection(t),this._searchString=null,this.$(".evo-search>input").val("").focus()},click_selection:function(e,t){this.$(".evo-toolbar .evo-tb-status");var i=this.$(".list-sel:checked").not('[data-id="cbxAll"]').length,l=this.getToolbarButtons();0<i?(this.setStatus(h.getLabel("selected",i)),l.del.show()):(this.setStatus(""),l.del.hide())}})}(),Evol.App=Backbone.View.extend({options:{elements:{nav:".evo-head-links",nav2:".evo-head-links2",content:"#evol"},style:"panel-default",useRouter:!0,pageSize:20,prefix:"evol-"},initialize:function(e){_.extend(this,this.options,e);var i={};_.forEach(this.uiModels,function(e,t){i[e.id||"uim"+t]=e}),this.uiModelsObj=i,this._tbs={},this._ents={};var t=this.elements;this.$nav2=$(t.nav2),this.setupRouter()},setupRouter:function(){var l=this,e=Backbone.Router.extend({routes:{"":"nav",":entity(/:view)(/:id)":"nav","*noroute":l.noRoute},nav:function(e,t,i){e&&l.uiModelsObj[e]&&l.setEntity(e,t,i)}});this.router=new e,Backbone.history.start()},setRoute:function(e,t){var i=this._tbs[this._curEntity].curView;return i?(Evol.Dico.setRoute(this.router,i.uiModel.id,i.viewName,e,t),Evol.Dico.setPageTitle(i.getTitle())):alert("Error: Invalid route (for app)."),this},noRoute:function(e){alert('Error: Invalid route "'+e+'".')},setEntity:function(e,t,i){function l(){a._setEntity(e,t,i)}function n(){s&&s.curView&&a.setRoute(s.curView.model.id,!1)}var a=this,s=this._tbs[this._curEntity];this._curEntity?s?s.proceedIfReady(l,n):n():l()},_setEntity:function(t,i,l){var n=this;function e(){n._ents[t].show().siblings().hide();var e=n._tbs[t];e&&(n._curEntity=t,e.curView.viewName!==i&&e.setView(i,!1,!1).setTitle(),l&&("1"===e.curView.cardinality?(e.setModelById(l),n.setRoute(l,!1)):n.setRoute("",!1)))}if(i=i||"list",this._ents[t])e();else{var a=$('<div data-eid="'+t+'"></div>');this._ents[t]=a,this.$el.children().hide(),this.$el.append(a),this.createEntity(a,this.uiModelsObj[t],[],i,l,e)}return this._curEntity!==t&&(this.$nav2.find(">li>a").removeClass("sel").filter('[data-id="'+t+'"]').addClass("sel"),this._curEntity=t),this},createEntity:function(n,a,e,s,o,r){var t,d,c,u=this;if(Evol.Config)if(Evol.Config.localStorage){var i=new Backbone.LocalStorage(this.prefix+(a.table||a.id));d=Backbone.Model.extend({localStorage:i}),c=Backbone.Collection.extend({model:d,localStorage:i})}else t=Evol.Config.url+a.id,d=Backbone.Model.extend({urlRoot:t}),c=Backbone.Collection.extend({model:d,url:t});else alert("Error: missing config file.");var h=new c;h.fetch({success:function(e){var t=h.at(0),i={el:n,mode:"list",model:t,modelClass:d,collection:h,collectionClass:c,uiModel:a,pageSize:u.pageSize,titleSelector:"#title",style:u.style};s&&(i.defaultView=s),u.useRouter&&(i.router=u.router);var l=new Evol.Toolbar(i).render();o&&"1"===l.cardinality&&l.setModelById(o),u._tbs&&(u._tbs[a.id]=l),r&&r(l)},error:function(e){alert("Error: invalid route (for app).")}})},_HTMLentities:function(e){return _.map(e,function(e){return'<li><a href="#'+e.id+'/list" data-id="'+e.id+'">'+e.namePlural+"</a></li>"}).join("")}});